// detail.js — COMPLET, prêt à coller

import { auth, db } from "./_shared/firebase.js";
import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  doc,
  getDoc,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ================= UTILS ================= */

function qs(id) {
  return document.getElementById(id);
}

function getParam(name) {
  return new URLSearchParams(location.search).get(name);
}

function setText(id, txt) {
  const el = qs(id);
  if (el) el.textContent = txt || "";
}

function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;"
  }[m]));
}

/* ================= ELEMENTS ================= */

const titleEl = qs("title");
const descEl = qs("desc");
const segmentEl = qs("segment");
const statusLine = qs("statusLine");

const btnMail = qs("btnMail");
const btnCall = qs("btnCall");
const btnReport = qs("btnReport");
const btnEditPhotos = qs("btnEditPhotos");

const form = qs("form");
const nameInput = qs("name");
const phoneInput = qs("phone");
const msgInput = qs("msg");
const noteEl = qs("note");

/* ================= STATE ================= */

const annonceId = getParam("id");
let annonce = null;
let currentUser = null;

/* ================= GUARDS ================= */

if (!annonceId) {
  alert("Annonce introuvable (id manquant).");
  location.href = "index.html";
}

/* ================= LOAD ANNONCE ================= */

async function loadAnnonce() {
  const ref = doc(db, "annonces_location", annonceId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("Annonce inexistante.");
    location.href = "index.html";
    return;
  }

  annonce = snap.data();

  // --- UI ---
  setText("title", annonce.titre);
  setText("desc", annonce.description);
  setText("segment", `${annonce.type || ""} • ${annonce.ville || ""}`);

  setText(
    "statusLine",
    `Statut : ${annonce.status || "inconnu"}`
  );

  // --- CONTACT ---
  if (annonce.contactEmail) {
    btnMail.href = `mailto:${annonce.contactEmail}?subject=${encodeURIComponent(
      "Annonce WAUKLINK : " + annonce.titre
    )}`;
  } else {
    btnMail.classList.add("hidden");
  }

  if (annonce.contactPhone) {
    btnCall.href = `tel:${annonce.contactPhone}`;
  } else {
    btnCall.classList.add("hidden");
  }

  // --- OWNER ONLY ---
  if (
    currentUser &&
    annonce.ownerUid &&
    currentUser.uid === annonce.ownerUid
  ) {
    btnEditPhotos.classList.remove("hidden");
    btnEditPhotos.href = `annonce_edit.html?id=${annonceId}`;
  }
}

/* ================= AUTH ================= */

onAuthStateChanged(auth, async (user) => {
  currentUser = user || null;
  await loadAnnonce();
});

/* ================= REPORT ================= */

btnReport.addEventListener("click", async () => {
  if (!currentUser) {
    alert("Connecte-toi pour signaler une annonce.");
    location.href = "auth/login.html";
    return;
  }

  const reason = prompt("Pourquoi signaler cette annonce ?");
  if (!reason) return;

  try {
    await addDoc(
      doc(db, "reports").parent,
      {
        annonceId,
        annonceTitre: annonce?.titre || "",
        annonceVille: annonce?.ville || "",
        annonceType: annonce?.type || "",
        annoncePrix: annonce?.prix || 0,
        annonceOwnerUid: annonce?.ownerUid || "",
        reporterUid: currentUser.uid,
        reporterEmail: currentUser.email || "",
        reason: reason.trim(),
        status: "open",
        createdAt: serverTimestamp()
      }
    );

    alert("✅ Signalement envoyé.");
  } catch (e) {
    console.error(e);
    alert("❌ Erreur lors du signalement.");
  }
});

/* ================= FORM CONTACT ================= */

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!annonce) return;

  const payload = {
    annonceId,
    annonceTitre: annonce.titre || "",
    ownerUid: annonce.ownerUid || "",
    name: nameInput.value.trim(),
    phone: phoneInput.value.trim(),
    message: msgInput.value.trim(),
    createdAt: serverTimestamp()
  };

  if (!payload.name || !payload.phone || !payload.message) {
    noteEl.textContent = "❌ Tous les champs sont obligatoires.";
    return;
  }

  try {
    await addDoc(doc(db, "demandes").parent, payload);
    noteEl.textContent = "✅ Demande envoyée.";
    form.reset();
  } catch (e) {
    console.error(e);
    noteEl.textContent = "❌ Erreur lors de l’envoi.";
  }
});
