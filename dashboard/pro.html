<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Espace PRO ‚Äî WAUKLINK</title>

  <!-- STYLE GLOBAL -->
  <link rel="stylesheet" href="../style.css">
</head>

<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Espace Professionnel ‚≠ê‚≠ê‚≠ê</div>
    </div>
    <nav class="topbar-nav">
      <a class="btn" href="../index.html">‚Üê Accueil</a>
      <a class="btn" href="../deposer/annonce-location.html">
        ‚ûï Nouvelle annonce PRO
      </a>
    </nav>
  </div>
</header>

<main class="container main-layout">
  <h2>Mes annonces PRO</h2>

  <p id="msg" class="meta" aria-live="polite"></p>

  <section id="grid" class="grid"></section>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>¬© WAUKLINK</span>
    <nav class="footer-nav">
      <a class="link" href="../pricing.html">Tarifs</a>
      <a class="link" href="../legal/index.html">CGU</a>
      <a class="link" href="../legal/privacy.html">Confidentialit√©</a>
      <a class="link" href="../legal/mentions-legales.html">
        Mentions l√©gales
      </a>
    </nav>
  </div>
</footer>

<!-- üîê AUTH -->
<script type="module" src="../auth/status.js"></script>

<!-- =========================
     LOGIQUE PRO
========================= -->
<script type="module">
  import { auth, db } from "../shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, query, where, orderBy,
    getDocs
  } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const grid = document.getElementById("grid");
  const msg  = document.getElementById("msg");

  const esc = s =>
    String(s ?? "").replace(/[&<>"']/g, m =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
    );

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.replace("../auth/login.html");
      return;
    }

    // üîê V√©rification r√¥le PRO
    const userSnap = await getDocs(
      query(
        collection(db, "users"),
        where("__name__", "==", user.uid)
      )
    );

   let isAllowed = false;

   userSnap.forEach(d => {
     const data = d.data();
     isAllowed = data.isPro === true || data.role === "admin";
   });

   if (!isAllowed) {
     msg.textContent = "‚õî Acc√®s r√©serv√© aux comptes PRO.";
     return;
   }

    loadProAnnonces(user.uid);
  });

  async function loadProAnnonces(uid) {
    grid.innerHTML = "";
    msg.textContent = "‚è≥ Chargement de vos annonces PRO‚Ä¶";

    const qy = query(
      collection(db, "annonces"),
      where("ownerUid", "==", uid),
      where("proOnly", "==", true),
      orderBy("createdAt", "desc")
    );

    const snap = await getDocs(qy);

    if (snap.empty) {
      msg.textContent =
        "Aucune annonce PRO pour le moment.";
      return;
    }

    msg.textContent = `${snap.size} annonce(s) PRO`;

    snap.forEach(d => {
      const a = d.data();

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <strong>${esc(a.titre || "Annonce")}</strong>
        <div class="meta">
          ${esc(a.ville || "‚Äî")} ‚Ä¢ ${esc(a.categorie || "‚Äî")}
        </div>
        <div class="meta">
          ${esc(a.prix ?? "‚Äî")} ‚Ç¨
        </div>
        <div class="meta">
          Statut : <b>${esc(a.status || "‚Äî")}</b>
        </div>
        <p class="meta" style="margin-top:10px">
          ${esc(a.description || "")}
        </p>
      `;

      grid.appendChild(card);
    });
  }
</script>

</body>
</html>
