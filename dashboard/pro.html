<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mes Annonces — WAUKLINK</title>
  <link rel="stylesheet" href="/wauklink-site/style.css">
</head>
<body>

<header class="topbar">
  <div class="container topbar-row">
    <h1>WAUKLINK</h1>
    <div class="subtitle">Gestion de mes annonces</div>
    <nav class="topbar-nav">
      <a class="btn" href="/wauklink-site/dashboard/index.html">← Dashboard</a>
    </nav>
  </div>
</header>

<main class="container main-layout">
  <h2>Liste de mes publications</h2>
  <p id="msg" class="meta"></p>
  <section id="grid" class="grid"></section>
</main>

<script type="module">
  import { auth, db } from "/wauklink-site/shared/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, query, where, orderBy, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const grid = document.getElementById("grid");
  const msg = document.getElementById("msg");

  onAuthStateChanged(auth, async (user) => {
    if (!user) { location.replace("/wauklink-site/auth/login.html"); return; }
    load(user.uid);
  });

  async function load(uid) {
    grid.innerHTML = "⏳ Chargement...";
    const q = query(collection(db, "annonces"), where("userId", "==", uid), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    if (snap.empty) {
      msg.textContent = "Vous n'avez aucune annonce.";
      grid.innerHTML = "";
      return;
    }

    grid.innerHTML = "";
    snap.forEach(d => {
      const a = d.data();
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <strong>${a.title}</strong>
        <p class="meta">${a.specialite || a.type} | ${a.city}</p>
        <p class="meta">Statut: <b>${a.status}</b></p>
        <div style="margin-top:10px; display:flex; gap:10px;">
            <a class="btn" href="../annonces/location-detail.html?id=${d.id}">Voir</a>
            <button class="btn btn-danger" onclick="del('${d.id}')">Supprimer</button>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  window.del = async (id) => {
    if(confirm("Supprimer cette annonce ?")) {
        await deleteDoc(doc(db, "annonces", id));
        location.reload();
    }
  };
</script>
</body>
</html>
