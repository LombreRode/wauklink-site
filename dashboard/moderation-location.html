<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK — Admin • Modération Location</title>
  <link rel="stylesheet" href="../style.css?v=1" />
  <style>
    .page{padding:24px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .meta{opacity:.85;font-size:13px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btnDanger{border-color:rgba(255,90,90,.35);background:rgba(255,90,90,.10)}
    .btnOk{border-color:rgba(90,255,160,.35);background:rgba(90,255,160,.10)}
  </style>
</head>
<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Admin • Modération • Location</div>
    </div>
    <nav style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <a href="../index.html">← Accueil</a>
      <a href="../annonces/location.html">Voir annonces</a>
    </nav>
  </div>
</header>

<main class="container page">
  <h2 style="margin:0">Annonces en attente (pending)</h2>
  <p class="meta">Clique “Valider” → status=active (visible sur la page Location).</p>

  <div id="msg" class="meta"></div>
  <div id="grid" class="grid"></div>
</main>

<script type="module">
  import { auth, db } from "../auth/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, query, where, orderBy, limit, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const grid = document.getElementById("grid");
  const msg = document.getElementById("msg");

  // ⚠️ TEMPORAIRE (Étape 3 = sécurité définitive)
  // Mets ton UID admin ici (ou plusieurs).
  const ADMIN_UIDS = [
    // "TON_UID_ICI"
  ];

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

  async function loadPending(){
    grid.innerHTML = "";
    msg.textContent = "Chargement…";

    const qy = query(
      collection(db, "annonces_location"),
      where("status", "==", "pending"),
      orderBy("createdAt", "desc"),
      limit(50)
    );

    const snap = await getDocs(qy);
    msg.textContent = `Pending: ${snap.size}`;

    if(!snap.size){
      grid.innerHTML = `<div class="meta">Aucune annonce pending.</div>`;
      return;
    }

    snap.forEach(d=>{
      const a = d.data();
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900">${esc(a.titre)}</div>
            <div class="meta">${esc(a.ville)} • ${esc(a.type)} • ${esc(a.surface||"")}</div>
            <div class="meta">${esc(a.prix)}€ • ${esc(a.contactEmail||"")}</div>
          </div>
        </div>
        <div class="meta" style="margin-top:10px;white-space:pre-wrap">${esc(a.description||"")}</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn btnOk" data-id="${d.id}" data-act="active">✅ Valider</button>
          <button class="btn btnDanger" data-id="${d.id}" data-act="rejected">❌ Refuser</button>
        </div>
      `;
      el.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if(!b) return;
        const id = b.dataset.id;
        const act = b.dataset.act;

        await updateDoc(doc(db, "annonces_location", id), { status: act });
        await loadPending();
      });

      grid.appendChild(el);
    });
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      alert("Connecte-toi pour accéder à l’admin.");
      location.href = "../auth/login.html";
      return;
    }

    // Étape 3 = on remplacera ça par une vraie sécurité (custom claims / règles)
    if(ADMIN_UIDS.length && !ADMIN_UIDS.includes(user.uid)){
      alert("Accès admin refusé (UID non autorisé). Étape 3 = sécurisation définitive.");
      location.href = "../index.html";
      return;
    }

    await loadPending();
  });
</script>

<script type="module" src="../auth/status.js"></script>
</body>
</html>
