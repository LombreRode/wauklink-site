<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî Admin ‚Ä¢ Mod√©ration Location</title>
  <link rel="stylesheet" href="/wauklink-site/style.css">
  <style>
    .page{padding:24px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .meta{opacity:.85;font-size:13px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btnDanger{border-color:rgba(255,90,90,.35);background:rgba(255,90,90,.10)}
    .btnOk{border-color:rgba(90,255,160,.35);background:rgba(90,255,160,.10)}
  </style>
</head>
<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Admin ‚Ä¢ Mod√©ration ‚Ä¢ Location</div>
    </div>
    <nav style="display:flex;gap:10px;flex-wrap:wrap">
      <a class="btn" href="/wauklink-site/admin/index.html">‚Üê Dashboard</a>
      <a class="btn" href="/wauklink-site/annonces/location.html">Voir annonces</a>
    </nav>
  </div>
</header>

<main class="container page">
  <h2 style="margin:0">Annonces en attente</h2>
  <p class="meta">Valider ‚Üí visible publiquement ‚Ä¢ Refuser ‚Üí retir√©e</p>
  <div id="msg" class="meta"></div>
  <div id="grid" class="grid"></div>
</main>

<script type="module">
  import { db } from "/wauklink-site/shared/firebase.js";
  import { requireAdmin } from "/wauklink-site/shared/guard.js";
  import {
    collection, query, where, orderBy, limit,
    getDocs, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const grid = document.getElementById("grid");
  const msg = document.getElementById("msg");

  const esc = s =>
    String(s ?? "").replace(/[&<>"']/g, m =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])
    );

  async function loadPending(){
    grid.innerHTML = "";
    msg.textContent = "‚è≥ Chargement‚Ä¶";

    const qy = query(
      collection(db, "annonces_location"),
      where("status", "==", "pending"),
      orderBy("createdAt", "desc"),
      limit(50)
    );

    const snap = await getDocs(qy);
    msg.textContent = `üìã ${snap.size} annonce(s) en attente`;

    if (!snap.size) {
      grid.innerHTML = `<div class="meta">Aucune annonce pending.</div>`;
      return;
    }

    snap.forEach(d => {
      const a = d.data();
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900">${esc(a.titre)}</div>
            <div class="meta">${esc(a.ville)} ‚Ä¢ ${esc(a.type)}</div>
            <div class="meta">${esc(a.prix)} ‚Ç¨</div>
          </div>
        </div>
        <div class="meta" style="margin-top:10px;white-space:pre-wrap">
          ${esc(a.description || "")}
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn btnOk">Valider</button>
          <button class="btn btnDanger">Refuser</button>
        </div>
      `;

      const [ok, no] = el.querySelectorAll("button");

      ok.onclick = async () => {
        await updateDoc(
          doc(db, "annonces_location", d.id),
          { status: "active" }
        );
        loadPending();
      };

      no.onclick = async () => {
        await updateDoc(
          doc(db, "annonces_location", d.id),
          { status: "removed" }
        );
        loadPending();
      };

      grid.appendChild(el);
    });
  }

  requireAdmin({
    redirectTo: "/wauklink-site/auth/login.html",
    onOk: loadPending
  });
</script>
</body>
</html>
