<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>WAUKLINK â€” Tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../style.css">
</head>
<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Tableau de bord</div>
    </div>
    <nav class="topbar-nav">
      <a class="btn" href="../index.html">â† Accueil</a>
    </nav>
  </div>

  <div id="userStatus" class="user-status hidden">
    ğŸ‘¤ <span id="userName"></span>
    <button id="logoutBtn">DÃ©connexion</button>
  </div>

  <div id="guestStatus" class="guest-status hidden">
    <a href="../auth/login.html">Connexion</a>
    <a href="../auth/register.html">Inscription</a>
  </div>
</header>

<main class="container main-layout">
  <h2>Mon tableau de bord</h2>

  <!-- ğŸ”° STATUT PRO -->
  <div id="proStatus" class="meta" style="margin:16px 0"></div>

  <div class="grid">
    <a class="card" href="../deposer/annonce-location.html">
      <strong>â• DÃ©poser une annonce</strong>
      <p class="meta">Publier une nouvelle annonce</p>
    </a>

    <a class="card" href="../urgences/index.html">
      <strong>ğŸš¨ Urgences</strong>
      <p class="meta">Voir les urgences</p>
    </a>

    <a class="card" href="../travaux/index.html">
      <strong>ğŸ› ï¸ Travaux</strong>
      <p class="meta">Voir les travaux</p>
    </a>

    <a class="card" href="../locations/immobilier.html">
      <strong>ğŸ  Locations</strong>
      <p class="meta">Voir les locations</p>
    </a>

    <a class="card" href="../profil/index.html">
      <strong>ğŸ‘¤ Mon profil</strong>
      <p class="meta">GÃ©rer mon compte</p>
    </a>
  </div>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>Â© WAUKLINK</span>
  </div>
</footer>

<!-- ğŸ” Protection utilisateur connectÃ© -->
<script type="module">
  import { requireUser } from "../shared/guard.js";
  requireUser({ redirectTo: "../auth/login.html" });
</script>

<!-- ğŸ‘¤ Connexion / DÃ©connexion -->
<script type="module" src="../shared/user_status.js"></script>

<!-- ğŸŸ¢ LOGIQUE PRO -->
<script type="module">
  import { auth, db } from "../shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, query, where, getDocs, addDoc, serverTimestamp
  } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const proStatus = document.getElementById("proStatus");

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return;

    const data = snap.data();

    // ğŸ‘‘ ADMIN
    if (data.role === "admin") {
      proStatus.textContent = "ğŸ‘‘ Administrateur";
      return;
    }

    // ğŸŸ¢ PRO
    if (data.isPro === true) {
      proStatus.textContent = "ğŸŸ¢ Compte PRO";
      return;
    }

    // â³ DEMANDE EN COURS ?
    const q = query(
      collection(db, "pro_requests"),
      where("userId", "==", user.uid),
      where("status", "==", "pending")
    );
    const reqSnap = await getDocs(q);

    if (!reqSnap.empty) {
      proStatus.textContent = "â³ Demande PRO en attente";
      return;
    }

    // ğŸ”˜ BOUTON PASSER PRO
    const btn = document.createElement("button");
    btn.className = "btn btn-ok";
    btn.textContent = "ğŸš€ Passer PRO";

    btn.onclick = async () => {
      btn.disabled = true;
      await addDoc(collection(db, "pro_requests"), {
        userId: user.uid,
        status: "pending",
        createdAt: serverTimestamp()
      });
      proStatus.textContent = "â³ Demande PRO envoyÃ©e";
    };

    proStatus.appendChild(btn);
  });
</script>

</body>
</html>
