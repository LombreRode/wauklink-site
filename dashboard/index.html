<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>WAUKLINK â€” Tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">

  <!-- STYLE GLOBAL -->
  <link rel="stylesheet" href="/wauklink-site/style.css">
</head>

<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Tableau de bord</div>
    </div>

    <nav class="topbar-nav">
      <a class="btn" href="/wauklink-site/index.html">
        â† Accueil
      </a>
    </nav>
  </div>

  <!-- ğŸ‘¤ UTILISATEUR CONNECTÃ‰ -->
  <div id="userNav" class="user-nav hidden">
    <img
      id="navAvatar"
      src="/wauklink-site/assets/avatar-default.png"
      alt="Avatar"
      style="
        width:36px;
        height:36px;
        border-radius:50%;
        object-fit:cover;
        border:1px solid #2ecc71;
      "
    >
    <a href="/wauklink-site/dashboard/index.html"
       class="btn btn-outline">
      ğŸ“Š Dashboard
    </a>
    <a href="/wauklink-site/profil/index.html"
       class="btn btn-outline">
      ğŸ‘¤ Profil
    </a>
    <button id="logoutBtn" class="btn btn-danger">
      DÃ©connexion
    </button>
  </div>

  <!-- ğŸ‘¥ INVITÃ‰ -->
  <div id="guestStatus" class="guest-status hidden">
    <a href="/wauklink-site/auth/login.html">Connexion</a>
    <a href="/wauklink-site/auth/register.html">Inscription</a>
  </div>
</header>

<main class="container main-layout">
  <h2>Mon tableau de bord</h2>

  <!-- ğŸ”° STATUT UTILISATEUR -->
  <div id="proStatus" class="meta" style="margin:16px 0"></div>

  <div class="grid">
    <a class="card" href="/wauklink-site/deposer/annonce-location.html">
      <strong>â• DÃ©poser une annonce</strong>
      <p class="meta">Publier une nouvelle annonce</p>
    </a>

    <a class="card" href="/wauklink-site/urgences/index.html">
      <strong>ğŸš¨ Urgences</strong>
      <p class="meta">Voir les urgences</p>
    </a>

    <a class="card" href="/wauklink-site/travaux/index.html">
      <strong>ğŸ› ï¸ Travaux</strong>
      <p class="meta">Voir les travaux</p>
    </a>

    <a class="card" href="/wauklink-site/locations/immobilier.html">
      <strong>ğŸ  Locations</strong>
      <p class="meta">Voir les locations</p>
    </a>

    <a class="card" href="/wauklink-site/profil/index.html">
      <strong>ğŸ‘¤ Mon profil</strong>
      <p class="meta">GÃ©rer mon compte</p>
    </a>
  </div>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>Â© WAUKLINK</span>
  </div>
</footer>

<!-- ğŸ” PROTECTION UTILISATEUR CONNECTÃ‰ -->
<script type="module">
  import { requireUser } from "/wauklink-site/shared/guard.js";
  requireUser({
    redirectTo: "/wauklink-site/auth/login.html"
  });
</script>

<!-- ğŸ‘¤ NAVBAR (avatar + logout) -->
<script type="module"
        src="/wauklink-site/shared/user_status.js">
</script>

<!-- ğŸŸ¢ STATUT PLAN UTILISATEUR -->
<script type="module">
  import { auth, db } from "/wauklink-site/shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, query, where, getDocs,
    addDoc, serverTimestamp
  } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const proStatus = document.getElementById("proStatus");

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return;

    const data = snap.data();
    proStatus.innerHTML = "";

    // ğŸ‘‘ ADMIN
    if (data.role === "admin") {
      proStatus.textContent = "ğŸ‘‘ Administrateur";
      return;
    }

    // ğŸŸ¢ PRO
    if (data.plan === "pro") {
      proStatus.textContent = "ğŸŸ¢ Compte Professionnel";
      return;
    }

    // ğŸŸ¡ PARTICULIER
    if (data.plan === "particulier") {
      proStatus.textContent = "ğŸŸ¡ Compte Particulier";
      return;
    }

    // â³ DEMANDE PRO EN COURS
    const q = query(
      collection(db, "pro_requests"),
      where("userId", "==", user.uid),
      where("status", "==", "pending")
    );

    const reqSnap = await getDocs(q);
    if (!reqSnap.empty) {
      proStatus.textContent =
        "â³ Demande Professionnel en attente";
      return;
    }

    // ğŸ”˜ GRATUIT â†’ DEMANDE PRO
    const btn = document.createElement("button");
    btn.className = "btn btn-ok";
    btn.textContent = "ğŸš€ Passer Professionnel";

    btn.onclick = async () => {
      btn.disabled = true;
      await addDoc(collection(db, "pro_requests"), {
        userId: user.uid,
        status: "pending",
        createdAt: serverTimestamp()
      });
      proStatus.textContent =
        "â³ Demande Professionnel envoyÃ©e";
    };

    proStatus.appendChild(btn);
  });
</script>

 <script type="module" src="/wauklink-site/shared/notifier.js"></script> 
</body>
</html>
