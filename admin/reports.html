<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî Admin ‚Ä¢ Signalements</title>
  <link rel="stylesheet" href="../style.css?v=1" />
  <style>
    .page{padding:24px 0}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .meta{opacity:.85;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-danger{border:1px solid rgba(255,80,80,.45);background:rgba(255,80,80,.12)}
    .btn-warn{border:1px solid rgba(245,158,11,.45);background:rgba(245,158,11,.12)}
    .btn-ok{border:1px solid rgba(80,255,160,.35);background:rgba(80,255,160,.12)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;opacity:.95}
    .pill-open{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12)}
    .pill-closed{border-color:rgba(80,255,160,.35);background:rgba(80,255,160,.10)}
    .pill-disabled{border-color:rgba(255,80,80,.45);background:rgba(255,80,80,.10)}
    .search{width:min(520px,100%);padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .item{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);border-radius:16px;padding:12px}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .title{font-weight:900}
    .muted{opacity:.8}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kvc{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
    .k{opacity:.75;font-size:12px}
    .v{font-weight:800}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pager{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:14px}
    dialog{border:none;border-radius:18px;padding:0;max-width:820px;width:min(92vw,820px);background:#0b1220;color:#fff}
    .modalTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;border-bottom:1px solid rgba(255,255,255,.14);padding:16px}
    .modalBody{padding:16px}
    .closeX{background:transparent;border:1px solid rgba(255,255,255,.14);border-radius:12px;color:#fff;padding:6px 10px;cursor:pointer}
    .hr{height:1px;background:rgba(255,255,255,.12);margin:14px 0}
    .note{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18)}
  </style>
</head>

<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Admin ‚Ä¢ Gestion des signalements</div>
    </div>
    <nav class="row">
      <a class="btn" href="../index.html" style="text-decoration:none">‚Üê Accueil</a>
      <a class="btn" href="./annonces.html" style="text-decoration:none">üõ†Ô∏è Admin Annonces</a>
      <button class="btn" id="btnLogout">D√©connexion</button>
    </nav>
  </div>
</header>

<main class="container page">
  <div class="card">
    <div class="top">
      <div>
        <div style="font-weight:900;font-size:18px">Signalements</div>
        <div class="meta" id="adminStatus">V√©rification admin‚Ä¶</div>
      </div>

      <div class="row">
        <input id="q" class="search" placeholder="Rechercher (titre, ville, email, raison‚Ä¶)" />
        <select id="filter" class="btn" style="padding:10px 12px">
          <option value="open">Ouverts</option>
          <option value="closed">Ferm√©s</option>
          <option value="all">Tous</option>
        </select>
        <button class="btn" id="btnRefresh">‚Üª Rafra√Æchir</button>
      </div>
    </div>

    <div class="note meta">
      Astuce : ‚ÄúD√©sactiver l‚Äôannonce‚Äù passe l‚Äôannonce en <b>status: disabled</b> (elle ne s‚Äôaffiche plus c√¥t√© public).
    </div>

    <div id="list" class="grid"></div>

    <div class="pager">
      <button id="prev" class="btn" disabled>‚óÄ Pr√©c√©dent</button>
      <span id="pageInfo" class="meta">Page 1</span>
      <button id="next" class="btn" disabled>Suivant ‚ñ∂</button>
    </div>
  </div>
</main>

<dialog id="dlg">
  <div class="modalTop">
    <div>
      <div id="dlgTitle" style="font-weight:900;font-size:18px">D√©tail signalement</div>
      <div id="dlgMeta" class="meta"></div>
    </div>
    <button class="closeX" id="dlgClose">‚úï</button>
  </div>
  <div class="modalBody" id="dlgBody"></div>
</dialog>

<script type="module">
  import { db, auth } from "../auth/firebase.js";
  import {
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  import {
    collection, query, where, orderBy, limit, startAfter, getDocs,
    doc, getDoc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---------- UI ----------
  const adminStatus = document.getElementById("adminStatus");
  const list = document.getElementById("list");
  const qInput = document.getElementById("q");
  const filterSel = document.getElementById("filter");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnLogout = document.getElementById("btnLogout");

  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  const pageInfo = document.getElementById("pageInfo");

  const dlg = document.getElementById("dlg");
  const dlgClose = document.getElementById("dlgClose");
  const dlgTitle = document.getElementById("dlgTitle");
  const dlgMeta = document.getElementById("dlgMeta");
  const dlgBody = document.getElementById("dlgBody");

  dlgClose.addEventListener("click", () => dlg.close());

  // ---------- Helpers ----------
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function fmtDate(ts){
    try {
      const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      if (!d) return "‚Äî";
      return d.toLocaleString("fr-FR");
    } catch { return "‚Äî"; }
  }
  function pillStatus(status){
    const st = String(status || "open");
    if (st === "closed") return `<span class="pill pill-closed">closed</span>`;
    return `<span class="pill pill-open">open</span>`;
  }

  // ---------- Admin check ----------
  let currentUser = null;
  let isAdmin = false;

  async function checkAdmin(uid){
    const uref = doc(db, "users", uid);
    const snap = await getDoc(uref);
    if (!snap.exists()) return false;
    const data = snap.data() || {};
    return data.isAdmin === true || String(data.role || "").toLowerCase() === "admin";
  }

  onAuthStateChanged(auth, async (u) => {
    currentUser = u || null;
    if (!currentUser) {
      adminStatus.textContent = "‚ùå Non connect√©. Redirection‚Ä¶";
      setTimeout(() => window.location.href = "../auth/login.html", 400);
      return;
    }
    try {
      isAdmin = await checkAdmin(currentUser.uid);
      if (!isAdmin) {
        adminStatus.textContent = "‚ùå Acc√®s refus√© (admin uniquement).";
        list.innerHTML = `<div class="meta">Tu n‚Äôes pas admin. V√©rifie <b>users/${esc(currentUser.uid)}</b> ‚Üí <b>isAdmin:true</b> (ou <b>role:'admin'</b>).</div>`;
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      adminStatus.textContent = `‚úÖ Admin OK ‚Äî ${currentUser.email || ""}`;
      await loadPage("stay");
    } catch (e) {
      console.error(e);
      adminStatus.textContent = "‚ùå Erreur check admin (voir console).";
    }
  });

  btnLogout.addEventListener("click", async () => {
    try { await signOut(auth); } catch(e){ console.error(e); }
  });

  // ---------- Pagination state ----------
  const PER_PAGE = 20;
  let page = 1;
  let lastDocSnap = null;
  let cursorStack = [];
  let rawItems = [];
  let viewItems = [];

  // ---------- Actions ----------
  async function setReportStatus(reportId, status){
    await updateDoc(doc(db, "reports", reportId), { status });
  }

  async function disableAnnonce(annonceId){
    await updateDoc(doc(db, "annonces_location", annonceId), { status: "disabled" });
  }

  async function deleteAnnonce(annonceId){
    await deleteDoc(doc(db, "annonces_location", annonceId));
  }

  async function deleteReport(reportId){
    await deleteDoc(doc(db, "reports", reportId));
  }

  function openDetailModal(r){
    dlgTitle.textContent = "D√©tail signalement";
    dlgMeta.textContent = `Report: ${r.id} ‚Ä¢ ${fmtDate(r.createdAt)} ‚Ä¢ ${r.status || "open"}`;
    dlgBody.innerHTML = `
      <div class="cols">
        <div class="kvc"><div class="k">Annonce ID</div><div class="v">${esc(r.annonceId || "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Owner UID</div><div class="v">${esc(r.annonceOwnerUid || "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Titre</div><div class="v">${esc(r.annonceTitre || "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Ville</div><div class="v">${esc(r.annonceVille || "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Type</div><div class="v">${esc(r.annonceType || "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Prix</div><div class="v">${esc(r.annoncePrix ?? "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Reporter email</div><div class="v">${esc(r.reporterEmail || "‚Äî")}</div></div>
        <div class="kvc"><div class="k">Reporter UID</div><div class="v">${esc(r.reporterUid || "‚Äî")}</div></div>
      </div>

      <div class="hr"></div>

      <div>
        <div class="k">Raison</div>
        <div style="margin-top:6px;white-space:pre-wrap">${esc(r.reason || "‚Äî")}</div>
      </div>
    `;
    dlg.showModal();
  }

  // ---------- Rendering ----------
  function applySearchAndFilter(){
    const f = filterSel.value;
    const s = (qInput.value || "").toLowerCase().trim();

    let items = rawItems.slice();

    if (f !== "all") {
      items = items.filter(x => String(x.status || "open") === f);
    }

    if (s) {
      items = items.filter(x => {
        const blob = (
          (x.annonceTitre||"") + " " +
          (x.annonceVille||"") + " " +
          (x.annonceType||"") + " " +
          (x.annoncePrix??"") + " " +
          (x.reporterEmail||"") + " " +
          (x.reason||"")
        ).toLowerCase();
        return blob.includes(s);
      });
    }

    viewItems = items;
    renderList(viewItems);
  }

  function renderList(items){
    list.innerHTML = "";

    if (!isAdmin) {
      list.innerHTML = `<div class="meta">Admin requis.</div>`;
      return;
    }

    if (!items.length) {
      list.innerHTML = `<div class="meta">Aucun signalement pour ce filtre.</div>`;
      return;
    }

    items.forEach((r) => {
      const el = document.createElement("div");
      el.className = "item";

      const st = String(r.status || "open");
      const pill = pillStatus(st);

      el.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="title">${esc(r.annonceTitre || "Annonce")}</div>
            <div class="meta">
              ${esc(r.annonceVille || "‚Äî")} ‚Ä¢ ${esc(r.annonceType || "‚Äî")} ‚Ä¢ ${esc(r.annoncePrix ?? "‚Äî")}‚Ç¨
              ‚Ä¢ ${pill}
            </div>
            <div class="meta muted" style="margin-top:6px">
              Motif : ${esc((r.reason || "").slice(0, 140))}${(r.reason||"").length > 140 ? "‚Ä¶" : ""}
            </div>
            <div class="meta" style="margin-top:6px">
              ${fmtDate(r.createdAt)} ‚Ä¢ Reporter : ${esc(r.reporterEmail || "anonyme")}
            </div>
          </div>

          <div class="row">
            <button class="btn" data-action="detail">üßæ D√©tail</button>
            ${st === "open"
              ? `<button class="btn btn-ok" data-action="close">‚úÖ Clore</button>`
              : `<button class="btn btn-warn" data-action="reopen">‚Ü© R√©ouvrir</button>`
            }
            <button class="btn btn-warn" data-action="disable">üö´ D√©sactiver annonce</button>
            <button class="btn btn-danger" data-action="delReport">üóëÔ∏è Suppr. report</button>
          </div>
        </div>

        <div class="actions">
          <span class="pill">annonceId: ${esc(r.annonceId || "‚Äî")}</span>
          <span class="pill">reportId: ${esc(r.id)}</span>
        </div>
      `;

      el.querySelector('[data-action="detail"]').addEventListener("click", () => openDetailModal(r));

      const closeBtn = el.querySelector('[data-action="close"]');
      if (closeBtn) closeBtn.addEventListener("click", async () => {
        try {
          await setReportStatus(r.id, "closed");
          alert("‚úÖ Report cl√¥tur√©.");
          await loadPage("stay");
        } catch (e) { console.error(e); alert("‚ùå Erreur (rules)."); }
      });

      const reopenBtn = el.querySelector('[data-action="reopen"]');
      if (reopenBtn) reopenBtn.addEventListener("click", async () => {
        try {
          await setReportStatus(r.id, "open");
          alert("‚úÖ Report r√©ouvert.");
          await loadPage("stay");
        } catch (e) { console.error(e); alert("‚ùå Erreur (rules)."); }
      });

      el.querySelector('[data-action="disable"]').addEventListener("click", async () => {
        if (!r.annonceId) return alert("Annonce ID manquant.");
        if (!confirm("D√©sactiver l‚Äôannonce ? (elle dispara√Æt du public)")) return;
        try {
          await disableAnnonce(r.annonceId);
          alert("‚úÖ Annonce d√©sactiv√©e (status: disabled).");
        } catch (e) { console.error(e); alert("‚ùå Erreur d√©sactivation (rules)."); }
      });

      el.querySelector('[data-action="delReport"]').addEventListener("click", async () => {
        if (!confirm("Supprimer ce report ?")) return;
        try {
          await deleteReport(r.id);
          alert("‚úÖ Report supprim√©.");
          await loadPage("stay");
        } catch (e) { console.error(e); alert("‚ùå Erreur suppression (rules)."); }
      });

      // Option ‚Äúsupprimer annonce‚Äù (tr√®s fort) via double confirm dans le d√©tail
      // -> tu peux l‚Äôutiliser depuis le popup en ajoutant un bouton si tu veux.

      list.appendChild(el);
    });
  }

  // ---------- Load (Firestore) ----------
  async function loadPage(direction="stay"){
    if (!isAdmin) return;

    const baseRef = collection(db, "reports");

    // On trie par createdAt desc (comme tes autres pages)
    let qy = query(baseRef, orderBy("createdAt", "desc"), limit(PER_PAGE));

    if (direction === "next" && lastDocSnap) {
      qy = query(baseRef, orderBy("createdAt", "desc"), startAfter(lastDocSnap), limit(PER_PAGE));
    }

    if (direction === "prev") {
      cursorStack.pop();
      const prevCursor = cursorStack[cursorStack.length - 1] || null;
      if (prevCursor) {
        qy = query(baseRef, orderBy("createdAt", "desc"), startAfter(prevCursor), limit(PER_PAGE));
      } else {
        qy = query(baseRef, orderBy("createdAt", "desc"), limit(PER_PAGE));
      }
    }

    const snap = await getDocs(qy);
    const docs = snap.docs;

    rawItems = docs.map(d => ({ id: d.id, ...d.data() }));
    lastDocSnap = docs.length ? docs[docs.length - 1] : null;

    if (direction === "next") {
      if (docs.length) cursorStack.push(docs[0]);
      page++;
    } else if (direction === "prev") {
      page = Math.max(1, page - 1);
    } else {
      page = 1;
      cursorStack = [];
      if (docs.length) cursorStack.push(docs[0]);
    }

    pageInfo.textContent = `Page ${page}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = docs.length < PER_PAGE;

    applySearchAndFilter();
  }

  // ---------- Events ----------
  qInput.addEventListener("input", () => applySearchAndFilter());
  filterSel.addEventListener("change", () => applySearchAndFilter());
  btnRefresh.addEventListener("click", () => loadPage("stay"));

  nextBtn.addEventListener("click", () => loadPage("next"));
  prevBtn.addEventListener("click", () => loadPage("prev"));

</script>

<script type="module" src="../auth/status.js"></script>
<script type="module" src="../auth/user_sync.js"></script>
</body>
</html>
