<script type="module">
  import { db } from "/shared/firebase.js";
  import { requireModerator } from "/shared/guard.js";
  import {
    collection, query, where, orderBy, getDocs,
    doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const rows = document.getElementById("rows");
  const msg = document.getElementById("msg");
  const setMsg = t => msg.textContent = t || "";

  async function loadPending() {
    setMsg("‚è≥ Chargement des annonces en attente‚Ä¶");
    rows.innerHTML = "";

    const qy = query(
      collection(db, "annonces_location"),
      where("status", "==", "pending"),
      orderBy("createdAt", "desc")
    );

    const snap = await getDocs(qy);

    if (snap.empty) {
      rows.innerHTML =
        `<tr><td colspan="7" class="meta">‚úÖ Aucune annonce en attente.</td></tr>`;
      setMsg("Tout est √† jour.");
      return;
    }

    setMsg(`üìã ${snap.size} annonce(s) en attente`);

    snap.forEach(d => {
      const a = d.data();
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><b>${a.titre || "Annonce"}</b></td>
        <td>${a.ville || "-"}</td>
        <td>${a.type || "-"}</td>
        <td>${a.prix ?? "-"} ‚Ç¨</td>
        <td class="meta">${a.ownerEmail || a.ownerUid || "-"}</td>
        <td><span class="pill">${a.status}</span></td>
        <td>
          <div class="row-actions">
            <button class="btn btn-ok">Valider</button>
            <button class="btn btn-danger">Refuser</button>
          </div>
        </td>
      `;

      const [ok, no] = tr.querySelectorAll("button");

      ok.onclick = async () => {
        await updateDoc(
          doc(db, "annonces_location", d.id),
          { status: "active" }
        );
        loadPending();
      };

      no.onclick = async () => {
        await updateDoc(
          doc(db, "annonces_location", d.id),
          { status: "removed" }
        );
        loadPending();
      };

      rows.appendChild(tr);
    });
  }

  requireModerator({
    redirectTo: "/auth/login.html",
    onOk: loadPending
  });
</script>
