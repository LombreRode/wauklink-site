<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî Admin (Annonces)</title>
  <link rel="stylesheet" href="../style.css?v=1" />
  <style>
    .page{padding:22px 0}
    .meta{opacity:.85;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .kpi{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .kpi .n{font-size:26px;font-weight:900}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    input,select{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left;vertical-align:top}
    th{opacity:.8}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .ok{border-color:rgba(80,255,160,.35);background:rgba(80,255,160,.12)}
    .warn{border-color:rgba(255,190,80,.45);background:rgba(255,190,80,.12)}
    .danger{border-color:rgba(255,80,80,.5);background:rgba(255,80,80,.15)}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;opacity:.9}
    .muted{opacity:.7}
  </style>
</head>
<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Admin ‚Äî Mod√©ration des annonces</div>
    </div>
    <nav style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn" href="index.html">Dashboard</a>
      <a class="btn" href="reports.html">üö© Signalements</a>
      <a class="btn" href="ratings.html">‚≠ê Notes</a>
      <a class="btn" href="../index.html">‚Üê Site</a>
    </nav>
  </div>
</header>

<main class="container page">
  <div class="grid">
    <div class="kpi"><div class="meta">Charg√©es</div><div class="n" id="kAll">0</div></div>
    <div class="kpi"><div class="meta">Active</div><div class="n" id="kActive">0</div></div>
    <div class="kpi"><div class="meta">Pending</div><div class="n" id="kPending">0</div></div>
    <div class="kpi"><div class="meta">Orphelines (owner manquant)</div><div class="n" id="kOrph">0</div></div>
  </div>

  <div class="toolbar">
    <input id="q" placeholder="Recherche: titre, ville, type, email, owner..." style="min-width:260px;flex:1" />
    <select id="filter">
      <option value="all">Tous status</option>
      <option value="pending">Pending</option>
      <option value="active">Active</option>
      <option value="removed">Removed</option>
    </select>
    <button class="btn" id="reload">‚Üª Recharger</button>
    <span class="meta" id="msg"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Annonce</th>
        <th>Status</th>
        <th>Owner</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</main>

<script type="module">
  import { db, auth } from "../auth/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, getDocs, doc, updateDoc, deleteField, orderBy, query
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const rows = document.getElementById("rows");
  const msg = document.getElementById("msg");
  const qInput = document.getElementById("q");
  const filter = document.getElementById("filter");
  const reloadBtn = document.getElementById("reload");

  const kAll = document.getElementById("kAll");
  const kActive = document.getElementById("kActive");
  const kPending = document.getElementById("kPending");
  const kOrph = document.getElementById("kOrph");

  let currentUser = null;
  onAuthStateChanged(auth, (u)=>{ currentUser = u || null; });

  function setMsg(t){ msg.textContent = t || ""; }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
  function fmtDate(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : (ts?.seconds ? new Date(ts.seconds*1000) : null);
      if(!d) return "-";
      return d.toLocaleString("fr-FR");
    }catch{ return "-"; }
  }

  // ‚úÖ Normalisation owner: accepte ownerId OU ownerUid, et force ownerUid
  async function fixOwnerUid(docId, data){
    const owner = data.ownerUid || data.ownerId || "";
    if(!owner){
      alert("‚ùå Aucun ownerId/ownerUid trouv√©.");
      return;
    }
    await updateDoc(doc(db,"annonces_location", docId), {
      ownerUid: owner,
      ownerId: deleteField()
    });
  }

  async function setStatus(docId, status){
    await updateDoc(doc(db,"annonces_location", docId), { status });
  }

  async function load(){
    setMsg("‚è≥ Chargement‚Ä¶");
    rows.innerHTML = "";

    const snap = await getDocs(query(
      collection(db,"annonces_location"),
      orderBy("createdAt","desc")
    ));

    const all = snap.docs.map(d => ({ id:d.id, ...d.data() }));

    // KPI
    kAll.textContent = all.length;
    kActive.textContent = all.filter(x=>x.status==="active").length;
    kPending.textContent = all.filter(x=>x.status==="pending").length;
    kOrph.textContent = all.filter(x=>!(x.ownerUid || x.ownerId)).length;

    // filtre + recherche
    const f = filter.value;
    const s = (qInput.value || "").toLowerCase().trim();

    const shown = all.filter(a=>{
      if(f !== "all" && (a.status||"") !== f) return false;
      if(!s) return true;
      const blob = [
        a.titre, a.title, a.ville, a.type, a.contactEmail,
        a.ownerUid, a.ownerId, a.status, a.duree, a.prix
      ].join(" ").toLowerCase();
      return blob.includes(s);
    });

    if(!shown.length){
      setMsg("‚úÖ Rien √† afficher.");
      return;
    }
    setMsg(`‚úÖ ${shown.length} ligne(s).`);

    shown.forEach(a=>{
      const owner = a.ownerUid || a.ownerId || "";
      const ownerOk = !!a.ownerUid; // on veut ownerUid
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="muted">${esc(fmtDate(a.createdAt))}</td>
        <td>
          <div style="font-weight:900">${esc(a.titre || a.title || "-")}</div>
          <div class="meta">${esc(a.ville||"-")} ‚Ä¢ ${esc(a.type||"-")} ‚Ä¢ ${esc(a.duree||"-")} ‚Ä¢ ${(a.prix ?? "-")}‚Ç¨</div>
          <div class="meta">Email: ${esc(a.contactEmail||"-")}</div>
          <div class="meta">DocId: ${esc(a.id)}</div>
        </td>
        <td>
          <span class="tag">${esc(a.status||"-")}</span>
        </td>
        <td>
          <div style="font-weight:900">${esc(owner || "-")}</div>
          <div class="meta">${ownerOk ? "ownerUid ‚úÖ" : (owner ? "ownerId ‚ö†Ô∏è" : "‚ùå aucun owner")}</div>
        </td>
        <td style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn ok">Valider</button>
          <button class="btn warn">Pending</button>
          <button class="btn danger">Removed</button>
          <button class="btn">Fix ownerUid</button>
        </td>
      `;

      const [bOk, bPen, bRem, bFix] = tr.querySelectorAll("button");

      bOk.onclick = async ()=>{
        try{
          // ‚úÖ avant validation: si ownerId -> ownerUid
          if(!a.ownerUid && a.ownerId){
            await fixOwnerUid(a.id, a);
          }
          await setStatus(a.id, "active");
          await load();
        }catch(e){
          console.error(e);
          alert("‚ùå Action refus√©e (rules/permissions) ou erreur. Voir Console F12.");
        }
      };

      bPen.onclick = async ()=>{
        try{
          if(!confirm("Mettre en pending ?")) return;
          await setStatus(a.id, "pending");
          await load();
        }catch(e){
          console.error(e);
          alert("‚ùå Action refus√©e (rules/permissions) ou erreur. Voir Console F12.");
        }
      };

      bRem.onclick = async ()=>{
        try{
          if(!confirm("Mettre en removed ?")) return;
          await setStatus(a.id, "removed");
          await load();
        }catch(e){
          console.error(e);
          alert("‚ùå Action refus√©e (rules/permissions) ou erreur. Voir Console F12.");
        }
      };

      bFix.onclick = async ()=>{
        try{
          await fixOwnerUid(a.id, a);
          await load();
        }catch(e){
          console.error(e);
          alert("‚ùå Fix ownerUid refus√© (rules/permissions). Voir Console F12.");
        }
      };

      rows.appendChild(tr);
    });
  }

  reloadBtn.onclick = load;
  filter.onchange = load;
  qInput.oninput = () => { /* filtre instant */ load(); };

  load();
</script>

<script type="module" src="../auth/status.js"></script>
<script type="module" src="../auth/user_sync.js"></script>
</body>
</html>
