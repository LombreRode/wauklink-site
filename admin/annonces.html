<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK â€” Admin (Annonces)</title>
  <link rel="stylesheet" href="../style.css?v=1" />
  <style>
    .wrap{padding:24px 0}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .meta{opacity:.85;font-size:13px}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
    .kpi .v{font-weight:900;font-size:22px}
    .ctrl{display:grid;grid-template-columns:1fr 220px 220px;gap:10px;margin-top:12px}
    @media (max-width:800px){ .ctrl{grid-template-columns:1fr} }
    input, select{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.2);color:#fff
    }
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;opacity:.85}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;opacity:.95}
    .btn{
      padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:#fff;cursor:pointer
    }
    .btn.danger{border-color:rgba(255,80,80,.45);background:rgba(255,80,80,.10)}
    .btn.ok{border-color:rgba(80,255,160,.35);background:rgba(80,255,160,.10)}
    .btn.warn{border-color:rgba(255,200,80,.35);background:rgba(255,200,80,.10)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;opacity:.85}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Admin â€” ModÃ©ration des annonces</div>
    </div>
    <nav class="row">
      <a class="btn" href="./index.html">Dashboard</a>
      <a class="btn" href="../annonces/location.html">Site public</a>
    </nav>
  </div>
</header>

<main class="container wrap">
  <div class="top">
    <h2 style="margin:0">Annonces</h2>
    <span class="tag" id="who">VÃ©rification adminâ€¦</span>
  </div>

  <div class="kpi">
    <div class="card"><div class="meta">ChargÃ©es</div><div class="v" id="kTotal">0</div></div>
    <div class="card"><div class="meta">Active</div><div class="v" id="kActive">0</div></div>
    <div class="card"><div class="meta">Pending</div><div class="v" id="kPending">0</div></div>
    <div class="card"><div class="meta">Orphelines</div><div class="v" id="kOrphan">0</div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:900">Actions rapides</div>
        <div class="meta">âœ… Valider â€¢ ðŸ•’ Pending â€¢ ðŸš« Removed â€¢ ðŸ›  Fix ownerUid â€¢ ðŸ—‘ Supprimer</div>
      </div>
      <div class="row">
        <button class="btn" id="btnReload">âŸ³ Recharger</button>
      </div>
    </div>

    <div class="ctrl">
      <input id="search" placeholder="Recherche : titre, ville, type, email, ownerUidâ€¦" />
      <select id="statusFilter">
        <option value="all">Tous statuts</option>
        <option value="active">Active</option>
        <option value="pending">Pending</option>
        <option value="removed">Removed</option>
        <option value="orphans">Orphelines (ownerUid manquant)</option>
      </select>
      <select id="limit">
        <option value="50">Charger 50</option>
        <option value="100" selected>Charger 100</option>
        <option value="200">Charger 200</option>
      </select>
    </div>

    <div class="small" style="margin-top:10px">
      Pro : mets les nouvelles annonces en <b>pending</b> Ã  la crÃ©ation, puis tu valides ici pour passer en <b>active</b>.
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Annonce</th>
            <th>Statut</th>
            <th>Owner</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="meta">Chargementâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<script type="module">
  import { db } from "../auth/firebase.js";
  import { requireAdmin } from "./_shared/guard.js";

  import {
    collection, query, orderBy, limit as qLimit, getDocs,
    doc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const who = document.getElementById("who");
  const btnReload = document.getElementById("btnReload");
  const tbody = document.getElementById("tbody");
  const search = document.getElementById("search");
  const statusFilter = document.getElementById("statusFilter");
  const limitSel = document.getElementById("limit");

  const kTotal = document.getElementById("kTotal");
  const kActive = document.getElementById("kActive");
  const kPending = document.getElementById("kPending");
  const kOrphan = document.getElementById("kOrphan");

  let currentUser = null; // admin connectÃ©
  let raw = [];          // annonces chargÃ©es

  const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const norm = (s)=> String(s ?? "").toLowerCase().trim();
  const fmtDate = (ts)=> { try{ const d = ts?.toDate ? ts.toDate() : null; return d ? d.toLocaleString("fr-FR") : "-"; } catch { return "-"; } };

  function computeKpis(items){
    kTotal.textContent = items.length;
    kActive.textContent = items.filter(a => a.status === "active").length;
    kPending.textContent = items.filter(a => a.status === "pending").length;
    kOrphan.textContent = items.filter(a => !a.ownerUid).length;
  }

  function render(items){
    computeKpis(raw);

    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="meta">Aucun rÃ©sultat.</td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(a => {
      const st = a.status || "-";
      const ownerTxt = a.ownerUid
        ? `<span class="mono">${esc(a.ownerUid)}</span>`
        : `<span class="tag" title="Annonce orpheline">NO ownerUid</span>`;

      const title = esc(a.titre || "Annonce");
      const meta = `${esc(a.ville||"-")} â€¢ ${esc(a.type||"-")} â€¢ ${esc(a.prix ?? "-")}â‚¬`;
      const date = fmtDate(a.createdAt);
      const photosCount = Array.isArray(a.photos) ? a.photos.filter(Boolean).length : 0;

      return `
        <tr data-id="${esc(a.id)}">
          <td class="meta">${esc(date)}</td>
          <td>
            <div style="font-weight:900">${title}</div>
            <div class="meta">${meta}</div>
            <div class="small">Photos: ${photosCount} â€¢ Email: ${esc(a.contactEmail||"-")}</div>
          </td>
          <td><span class="tag">${esc(st)}</span></td>
          <td>${ownerTxt}</td>
          <td>
            <div class="actions">
              <button class="btn ok" data-act="approve">âœ… Valider</button>
              <button class="btn warn" data-act="pending">ðŸ•’ Pending</button>
              <button class="btn" data-act="remove">ðŸš« Removed</button>
              <button class="btn" data-act="fixOwner">ðŸ›  Fix ownerUid</button>
              <button class="btn danger" data-act="delete">ðŸ—‘ Supprimer</button>
            </div>
            <div class="small meta" style="margin-top:6px">
              DocId: <span class="mono">${esc(a.id)}</span>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  function applyFilters(){
    const q = norm(search.value);
    const f = statusFilter.value;

    let items = raw.slice();

    if (f === "orphans") items = items.filter(a => !a.ownerUid);
    else if (f !== "all") items = items.filter(a => (a.status || "") === f);

    if (q) {
      items = items.filter(a => {
        const blob = norm(
          (a.titre||"") + " " + (a.ville||"") + " " + (a.type||"") + " " +
          (a.contactEmail||"") + " " + (a.contactPhone||"") + " " + (a.ownerUid||"")
        );
        return blob.includes(q);
      });
    }

    render(items);
  }

  async function load(){
    tbody.innerHTML = `<tr><td colspan="5" class="meta">Chargementâ€¦</td></tr>`;
    const lim = Number(limitSel.value) || 100;
    const qy = query(collection(db, "annonces_location"), orderBy("createdAt", "desc"), qLimit(lim));
    const snap = await getDocs(qy);
    raw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    applyFilters();
  }

  async function act(id, action){
    const a = raw.find(x => x.id === id);
    if (!a) return;

    const ref = doc(db, "annonces_location", id);

    if (action === "approve") {
      if (!confirm("Valider cette annonce (status=active) ?")) return;
      await updateDoc(ref, { status: "active" });
    }

    if (action === "pending") {
      if (!confirm("Mettre cette annonce en pending ?")) return;
      await updateDoc(ref, { status: "pending" });
    }

    if (action === "remove") {
      if (!confirm("DÃ©sactiver sans supprimer (status=removed) ?")) return;
      await updateDoc(ref, { status: "removed" });
    }

    if (action === "fixOwner") {
      if (a.ownerUid) { alert("âœ… ownerUid existe dÃ©jÃ ."); return; }
      if (!confirm("Assigner ownerUid = TON UID admin sur cette annonce orpheline ?")) return;
      await updateDoc(ref, { ownerUid: currentUser.uid });
    }

    if (action === "delete") {
      if (!confirm("SUPPRIMER dÃ©finitivement ? (irrÃ©versible)")) return;
      await deleteDoc(ref);
    }

    await load();
  }

  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;

    try {
      btn.disabled = true;
      await act(tr.dataset.id, btn.dataset.act);
    } catch (err) {
      console.error(err);
      alert("âŒ Action refusÃ©e (rules/permissions) ou erreur. Voir Console F12.");
    } finally {
      btn.disabled = false;
    }
  });

  btnReload.addEventListener("click", load);
  search.addEventListener("input", applyFilters);
  statusFilter.addEventListener("change", applyFilters);
  limitSel.addEventListener("change", load);

  // âœ… GARDE ADMIN (centralisÃ©)
  requireAdmin({
    redirectTo: "../index.html",
    onOk: async (user) => {
      currentUser = user;
      who.textContent = "ADMIN OK";
      await load();
    },
    onLoading: () => {
      who.textContent = "VÃ©rification adminâ€¦";
    }
  });
</script>

<script type="module" src="../auth/status.js"></script>
</body>
</html>
