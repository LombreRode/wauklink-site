<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin — Annonces</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
<h1>Annonces à valider</h1>
<div id="list">Chargement…</div>

<script type="module">
  import { db } from "../_shared/firebase.js";
  import { requireModeration } from "../_shared/guard.js";
  import {
    collection, query, where, getDocs, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const list = document.getElementById("list");

  async function load() {
    list.textContent = "Chargement…";
    const q = query(
      collection(db, "annonces_location"),
      where("status", "==", "pending")
    );
    const snap = await getDocs(q);

    list.innerHTML = "";
    if (snap.empty) {
      list.textContent = "Aucune annonce en attente.";
      return;
    }

    snap.forEach(d => {
      const a = d.data();
      const div = document.createElement("div");
      div.innerHTML = `
        <b>${a.titre || "Annonce"}</b>
        <button>Valider</button>
        <button>Refuser</button>
      `;
      const [ok,no] = div.querySelectorAll("button");
      ok.onclick = () => updateDoc(doc(db,"annonces_location",d.id),{status:"active"}).then(load);
      no.onclick = () => updateDoc(doc(db,"annonces_location",d.id),{status:"removed"}).then(load);
      list.appendChild(div);
    });
  }

  requireModeration({
    redirectTo: "../index.html",
    onOk: load
  });
</script>

<script type="module" src="../auth/status.js"></script>
</body>
</html>
