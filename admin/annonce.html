<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin ‚Äî Fiche annonce</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/wauklink-site/style.css">
</head>

<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Fiche annonce (Admin)</div>
    </div>
    <nav class="topbar-nav">
      <a class="btn" href="/wauklink-site/admin/annonces.html">‚Üê Annonces</a>
    </nav>
  </div>
</header>

<main class="container main-layout">
  <p id="msg" class="meta">Chargement‚Ä¶</p>

  <section id="annonceBox" class="card hidden">
    <h2 id="title"></h2>

    <p class="meta" id="meta"></p>

    <span id="statusBadge" class="badge"></span>

    <p id="description" style="margin-top:12px"></p>

    <h3>Photos</h3>
    <div id="photos" class="grid"></div>

    <h3>Utilisateur</h3>
    <p class="meta" id="user"></p>

    <h3>Actions admin</h3>
    <div class="row-actions">
      <button id="btnActivate" class="btn btn-ok hidden">Activer</button>
      <button id="btnDisable" class="btn btn-warning hidden">D√©sactiver</button>
      <button id="btnDelete" class="btn btn-danger">Supprimer</button>
    </div>
  </section>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>¬© WAUKLINK</span>
  </div>
</footer>

<script type="module">
import { db } from "../shared/firebase.js";
import { requireAdmin } from "../shared/guard.js";
import {
  doc,
  getDoc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const msg   = document.getElementById("msg");
const box   = document.getElementById("annonceBox");
const title = document.getElementById("title");
const meta  = document.getElementById("meta");
const desc  = document.getElementById("description");
const photosEl = document.getElementById("photos");
const userEl   = document.getElementById("user");
const badge    = document.getElementById("statusBadge");

const btnActivate = document.getElementById("btnActivate");
const btnDisable  = document.getElementById("btnDisable");
const btnDelete   = document.getElementById("btnDelete");

const annonceId = new URLSearchParams(location.search).get("id");

if (!annonceId) {
  msg.textContent = "‚ùå ID annonce manquant";
}

/* ===== helpers statut ===== */
function statusLabel(status) {
  if (status === "active") return "üü¢ Active";
  if (status === "disabled") return "üü† D√©sactiv√©e";
  return "üü° En attente";
}

function statusClass(status) {
  if (status === "active") return "badge-ok";
  if (status === "disabled") return "badge-warning";
  return "badge-muted";
}

async function setStatus(ref, status, label) {
  if (!confirm(`Confirmer : ${label} ?`)) return;
  await updateDoc(ref, { status });
  await loadAnnonce();
}

/* ===== chargement annonce ===== */
async function loadAnnonce() {
  const ref = doc(db, "annonces", annonceId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    msg.textContent = "‚ùå Annonce introuvable";
    return;
  }

  const a = snap.data();

  title.textContent = a.title || "Annonce";
  meta.textContent  = `${a.type} ‚Ä¢ ${a.city} ‚Ä¢ ${a.price ?? "‚Äî"} ‚Ç¨`;
  desc.textContent  = a.description || "";
  userEl.textContent = a.ownerUid || "‚Äî";

  badge.textContent = statusLabel(a.status);
  badge.className   = `badge ${statusClass(a.status)}`;

  photosEl.innerHTML = "";
  (a.photos || []).forEach(url => {
    const img = document.createElement("img");
    img.src = url;
    img.style.borderRadius = "8px";
    photosEl.appendChild(img);
  });

  // boutons selon statut
  btnActivate.classList.toggle(
    "hidden",
    a.status === "active"
  );

  btnDisable.classList.toggle(
    "hidden",
    a.status !== "active"
  );

  btnActivate.onclick = () =>
    setStatus(ref, "active", "Activer l‚Äôannonce");

  btnDisable.onclick  = () =>
    setStatus(ref, "disabled", "D√©sactiver l‚Äôannonce");

  btnDelete.onclick = async () => {
    if (!confirm("‚ö†Ô∏è Supprimer d√©finitivement cette annonce ?")) return;
    await deleteDoc(ref);
    location.href = "/wauklink-site/admin/annonces.html";
  };

  msg.textContent = "";
  box.classList.remove("hidden");
}

requireAdmin({
  onOk: loadAnnonce,
  onDenied: () => msg.textContent = "‚õî Acc√®s refus√©"
});
</script>
</body>
</html>
