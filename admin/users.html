<script type="module">
import { requireAdmin } from "/wauklink-site/shared/guard.js";
import { db } from "/wauklink-site/shared/firebase.js";
import {
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {
  const list = document.getElementById("list");
  const msg  = document.getElementById("msg");

  if (!list || !msg) {
    console.error("‚ùå √âl√©ments admin manquants");
    return;
  }

  async function loadUsers() {
    msg.textContent = "‚è≥ Chargement des utilisateurs (vue admin)‚Ä¶";
    list.innerHTML = "";

    try {
      const snap = await getDocs(collection(db, "users"));

      if (snap.empty) {
        msg.textContent = "Aucun utilisateur.";
        list.innerHTML =
          "<p class='meta'>Aucune donn√©e disponible.</p>";
        return;
      }

      msg.textContent = `üë§ ${snap.size} utilisateur(s)`;

      snap.forEach(d => {
        const u = d.data();
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <strong>${u.email || "‚Äî"}</strong>
          <div class="meta">
            R√¥le : ${u.role || "user"}
          </div>
        `;
        list.appendChild(card);
      });

    } catch (err) {
      console.error("‚ùå Admin users error:", err);
      msg.textContent = "‚ùå Acc√®s interdit (rules Firestore)";
      list.innerHTML =
        "<p class='meta'>Lecture globale non autoris√©e.</p>";
    }
  }

  // üîê ADMIN UNIQUEMENT
  requireAdmin({
    redirectTo: "/wauklink-site/auth/login.html",
    onOk: () => {
      msg.textContent = "‚úÖ Acc√®s admin confirm√©";
      loadUsers();
    }
  });
});
</script>
