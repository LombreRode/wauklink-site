<script type="module">
import { db, auth } from "/wauklink-site/shared/firebase.js";
import { requireAdmin } from "/wauklink-site/shared/guard.js";
import { logAdminAction } from "/wauklink-site/shared/admin_logger.js";
import {
  collection,
  getDocs,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const list = document.getElementById("list");
const msg  = document.getElementById("msg");

const esc = s =>
  String(s ?? "").replace(/[&<>"']/g, m =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;",
       '"':"&quot;","'":"&#039;" }[m])
  );

function badge(u) {
  if (u.role === "admin") return "üëë Administrateur";
  if (u.plan === "pro") return "üü¢ Professionnel";
  if (u.plan === "particulier") return "üü° Particulier";
  return "‚ö™ Gratuit";
}

async function loadUsers() {
  list.innerHTML = "";
  msg.textContent = "Chargement‚Ä¶";

  const snap = await getDocs(collection(db, "users"));

  if (snap.empty) {
    msg.textContent = "Aucun utilisateur";
    return;
  }

  msg.textContent = `${snap.size} utilisateur(s)`;

  snap.forEach(d => {
    const u   = d.data();
    const uid = d.id;

    const card = document.createElement("div");
    card.className = "card";

    let controls = `<div class="meta">${badge(u)}</div>`;

    if (u.role !== "admin") {
      controls += `
        <label class="meta">Plan</label>
        <select class="planSelect">
          <option value="free">Gratuit</option>
          <option value="particulier">Particulier</option>
          <option value="pro">Professionnel</option>
        </select>
      `;
    }

    card.innerHTML = `
      <strong>${esc(u.firstName)} ${esc(u.lastName)}</strong>
      <div class="meta">${esc(u.email)}</div>
      <div class="row-actions" style="margin-top:12px">
        ${controls}
      </div>
    `;

    const select = card.querySelector(".planSelect");

    if (select) {
      select.value = u.plan || "free";

      select.onchange = async () => {
        const newPlan = select.value;

        if (!confirm(
          `Changer le plan de cet utilisateur en "${newPlan}" ?`
        )) {
          select.value = u.plan || "free";
          return;
        }

        try {
          await updateDoc(doc(db, "users", uid), {
            plan: newPlan,
            isPro: newPlan === "pro"
          });

          await logAdminAction({
            action: "user_plan_change",
            adminUid: auth.currentUser?.uid,
            adminEmail: auth.currentUser?.email,
            extra: {
              userId: uid,
              newPlan
            }
          });

          alert("‚úÖ Plan mis √† jour");
          loadUsers();
        } catch (err) {
          console.error(err);
          alert("‚ùå Erreur lors de la mise √† jour");
          select.value = u.plan || "free";
        }
      };
    }

    list.appendChild(card);
  });
}

requireAdmin({
  onOk: loadUsers,
  onDenied: () => {
    msg.textContent = "‚õî Acc√®s r√©serv√© aux administrateurs";
    list.innerHTML = "";
  }
});
</script>
