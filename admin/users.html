<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin â€” Utilisateurs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../style.css">
</head>

<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Admin â€” Utilisateurs</div>
    </div>
    <nav class="topbar-nav">
      <a class="btn" href="./index.html">â† Admin</a>
    </nav>
  </div>
</header>

<main class="container main-layout">
  <h2>ğŸ‘¥ Tous les utilisateurs</h2>
  <p id="msg" class="meta">Chargementâ€¦</p>
  <section id="list" class="grid"></section>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>Â© WAUKLINK</span>
  </div>
</footer>

<script type="module">
  import { db } from "../shared/firebase.js";
  import { requireAdmin } from "../shared/guard.js";
  import {
    collection, getDocs, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const list = document.getElementById("list");
  const msg  = document.getElementById("msg");

  async function loadUsers() {
    list.innerHTML = "";
    const snap = await getDocs(collection(db, "users"));

    if (snap.empty) {
      msg.textContent = "Aucun utilisateur";
      return;
    }

    msg.textContent = `${snap.size} utilisateur(s)`;

    snap.forEach(d => {
      const u = d.data();
      const uid = d.id;

      let badge = "âšª Utilisateur";
      if (u.role === "admin") badge = "ğŸ‘‘ Administrateur";
      else if (u.isPro === true) badge = "ğŸŸ¢ Compte PRO";

      const card = document.createElement("div");
      card.className = "card";

      let actions = "";

      // âŒ On ne touche jamais aux admins
      if (u.role !== "admin") {
        if (u.isPro === true) {
          actions = `
            <button class="btn btn-danger" data-action="remove">
              Retirer PRO
            </button>
          `;
        } else {
          actions = `
            <button class="btn btn-ok" data-action="add">
              Passer PRO
            </button>
          `;
        }
      }

      card.innerHTML = `
        <strong>${u.firstName || "â€”"}</strong>
        <div class="meta">${u.email || ""}</div>
        <div class="meta">${badge}</div>
        <div class="row-actions" style="margin-top:12px">
          ${actions}
        </div>
      `;

      const btn = card.querySelector("button");

      if (btn) {
        btn.onclick = async () => {
          const isAdd = btn.dataset.action === "add";
          const confirmMsg = isAdd
            ? "Passer ce compte en PRO ?"
            : "Retirer le statut PRO ?";

          if (!confirm(confirmMsg)) return;

          await updateDoc(doc(db, "users", uid), {
            isPro: isAdd
          });

          loadUsers();
        };
      }

      list.appendChild(card);
    });
  }

  requireAdmin({
    onOk: loadUsers,
    onDenied: () => {
      msg.textContent = "â›” AccÃ¨s rÃ©servÃ© aux administrateurs";
    }
  });
</script>
</body>
</html>
