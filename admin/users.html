<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Admin â€” Utilisateurs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="../style.css">
</head>
<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Administration â€” Utilisateurs</div>
    </div>
    <nav class="topbar-nav">
      <a class="btn" href="./index.html">â† Admin</a>
    </nav>
  </div>
</header>

<main class="container main-layout">
  <h2>ğŸ‘¥ Tous les utilisateurs</h2>
  <p id="msg" class="meta">Chargementâ€¦</p>
  <section id="list" class="grid"></section>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>Â© WAUKLINK</span>
  </div>
</footer>

<script type="module">
import { db } from "../shared/firebase.js";
import { requireAdmin } from "../shared/guard.js";
import {
  collection,
  getDocs,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const list = document.getElementById("list");
const msg  = document.getElementById("msg");

function badgeForUser(u) {
  if (u.role === "admin") return "ğŸ‘‘ Administrateur";
  if (u.plan === "pro") return "ğŸŸ¢ Professionnel";
  if (u.plan === "particulier") return "ğŸŸ¡ Particulier";
  return "âšª Gratuit";
}

async function loadUsers() {
  list.innerHTML = "";
  msg.textContent = "Chargementâ€¦";

  const snap = await getDocs(collection(db, "users"));

  if (snap.empty) {
    msg.textContent = "Aucun utilisateur";
    return;
  }

  msg.textContent = `${snap.size} utilisateur(s)`;

  snap.forEach(d => {
    const u = d.data();
    const uid = d.id;

    const card = document.createElement("div");
    card.className = "card";

    let actions = "";
    if (u.role !== "admin") {
      actions = `
        <label class="meta">Plan utilisateur</label>
        <select class="planSelect">
          <option value="free">Gratuit</option>
          <option value="particulier">Particulier</option>
          <option value="pro">Professionnel</option>
        </select>
      `;
    }

    card.innerHTML = `
      <strong>${u.firstName || "â€”"}</strong>
      <div class="meta">${u.email || ""}</div>
      <div class="meta">${badgeForUser(u)}</div>
      <div class="row-actions" style="margin-top:12px">
        ${actions}
      </div>
    `;

    const select = card.querySelector(".planSelect");

    if (select) {
      select.value = u.plan || "free";

      select.onchange = async () => {
        const newPlan = select.value;

        if (!confirm(`Changer le plan de cet utilisateur en "${newPlan}" ?`)) {
          select.value = u.plan || "free";
          return;
        }

        try {
          await updateDoc(doc(db, "users", uid), {
            plan: newPlan,
            isPro: newPlan === "pro"
          });

          alert("âœ… Plan utilisateur mis Ã  jour");
          loadUsers();

        } catch (err) {
          console.error(err);
          alert("âŒ Erreur lors de la mise Ã  jour");
          select.value = u.plan || "free";
        }
      };
    }

    list.appendChild(card);
  });
}

requireAdmin({
  onOk: loadUsers,
  onDenied: () => {
    msg.textContent = "â›” AccÃ¨s rÃ©servÃ© aux administrateurs";
    list.innerHTML = "";
  }
});
</script>

</body>
</html>
