<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî D√©poser une annonce</title>
  <link rel="stylesheet" href="../style.css?v=1" />
</head>

<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">D√©poser une annonce</div>
    </div>
    <nav>
      <a class="btn" href="../index.html">‚Üê Retour</a>
    </nav>
  </div>
</header>

<main class="container wrap">
  <div class="card">
    <p class="meta">
      Toutes les annonces sont v√©rifi√©es par un administrateur avant publication.
    </p>

    <form id="form">
      <div class="row">
        <input id="titre" placeholder="Titre" required />
        <input id="ville" placeholder="Ville" required />
      </div>

      <div class="row">
        <select id="duree" required>
          <option value="">Type de location</option>
          <option value="saisonniere">Location saisonni√®re</option>
          <option value="annuelle">Location annuelle</option>
        </select>
        <select id="type" required>
          <option value="">Type de bien</option>
          <option>Appartement</option>
          <option>Maison</option>
          <option>Studio</option>
          <option>Chambre</option>
        </select>
      </div>

      <div class="row">
        <input id="surface" type="number" placeholder="Surface (m¬≤)" />
        <input id="prix" type="number" placeholder="Prix (‚Ç¨)" required />
      </div>

      <div class="row">
        <input id="contactEmail" type="email" placeholder="Email contact" required />
        <input id="contactPhone" placeholder="T√©l√©phone (optionnel)" />
      </div>

      <textarea id="description" placeholder="Description" required></textarea>

      <div>
        <input id="photosInput" type="file" accept="image/*" multiple />
        <div id="photosPreview"></div>
      </div>

      <button class="btn ok" id="submitBtn">üì§ Publier</button>
      <div id="msg" class="meta"></div>
    </form>
  </div>
</main>

<!-- ================= JS ================= -->
<script type="module">
  import { auth, db, storage } from "../_shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, addDoc, doc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const form = document.getElementById("form");
  const msg = document.getElementById("msg");
  const photosInput = document.getElementById("photosInput");
  const photosPreview = document.getElementById("photosPreview");
  let user = null;
  let files = [];

  function setMsg(t){ msg.textContent = t || ""; }

  onAuthStateChanged(auth, u=>{
    if(!u){
      setMsg("‚ùå Connexion requise.");
      form.style.display="none";
      return;
    }
    user = u;
  });

  photosInput.onchange = ()=>{
    files = [...photosInput.files].slice(0,6);
    photosPreview.innerHTML="";
    files.forEach(f=>{
      const img=document.createElement("img");
      img.src=URL.createObjectURL(f);
      img.style.width="80px";
      img.style.borderRadius="10px";
      photosPreview.appendChild(img);
    });
  };

  form.onsubmit = async e=>{
    e.preventDefault();
    if(!user) return;

    try{
      setMsg("‚è≥ Cr√©ation‚Ä¶");

      const annonceRef = await addDoc(collection(db,"annonces_location"),{
        titre: titre.value,
        ville: ville.value,
        duree: duree.value,
        type: type.value,
        surface: Number(surface.value||0),
        prix: Number(prix.value),
        description: description.value,
        contactEmail: contactEmail.value,
        contactPhone: contactPhone.value,
        ownerUid: user.uid,
        ownerEmail: user.email,
        status: "pending",
        photos: [],
        photoPaths: [],
        ratingAvg: 0,
        ratingCount: 0,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      const urls=[], paths=[];
      for(let i=0;i<files.length;i++){
        const path=`annonces_location/${annonceRef.id}/p${i+1}.jpg`;
        const r=ref(storage,path);
        await uploadBytes(r,files[i]);
        urls.push(await getDownloadURL(r));
        paths.push(path);
      }

      await updateDoc(doc(db,"annonces_location",annonceRef.id),{
        photos: urls,
        photoPaths: paths,
        updatedAt: serverTimestamp()
      });

      setMsg("‚úÖ Annonce envoy√©e !");
      setTimeout(()=>location.href="../annonces/location.html?duree="+duree.value,700);

    }catch(e){
      console.error(e);
      setMsg("‚ùå Erreur (voir console)");
    }
  };
</script>

<script type="module" src="../auth/status.js"></script>
<script type="module" src="../auth/user_sync.js"></script>

</body>
</html>
