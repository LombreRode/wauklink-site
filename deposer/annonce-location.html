<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî D√©poser une annonce</title>
  <link rel="stylesheet" href="../style.css?v=1" />
  <style>
    .page{padding:24px 0}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input, textarea, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:#fff}
    label{display:block;font-weight:800;margin:10px 0 6px}
    .meta{opacity:.85;font-size:13px;white-space:pre-line}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px}
    .photo{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px;background:rgba(255,255,255,.04)}
    .photo img{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.12)}
    .hr{border:none;height:1px;background:rgba(255,255,255,.12);margin:16px 0}
  </style>
</head>
<body>

<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">D√©poser une annonce</div>
    </div>
    <nav class="row">
      <a class="btn" href="../index.html" style="text-decoration:none">‚Üê Accueil</a>
      <a class="btn" href="../annonces/index.html" style="text-decoration:none">üìã Annonces</a>
    </nav>
  </div>
</header>

<main class="container page">
  <div class="card">
    <div class="meta" id="msg">Chargement‚Ä¶</div>

    <form id="form">
      <label>Titre</label>
      <input id="titre" required placeholder="Ex: Peinture + petits travaux" />

      <label>Ville</label>
      <input id="ville" required placeholder="Ex: Paris" />

      <label>Type</label>
      <input id="type" required placeholder="Ex: Travaux" />

      <label>Prix (‚Ç¨)</label>
      <input id="prix" type="number" min="0" step="1" required value="0" />

      <label>Description</label>
      <textarea id="description" rows="5" placeholder="D√©cris ton service / besoin..."></textarea>

      <hr class="hr">

      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:900">Photos</div>
          <div class="meta">Elles seront envoy√©es sur Firebase Storage (plus Cloudinary).</div>
        </div>
        <div class="row">
          <input id="files" type="file" accept="image/*" multiple />
        </div>
      </div>

      <div id="preview" class="grid"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnPublish" type="submit">‚úÖ Publier l‚Äôannonce</button>
      </div>

      <div class="meta" style="margin-top:10px">
        Astuce : tu peux publier sans photo, puis modifier apr√®s.
      </div>
    </form>
  </div>
</main>

<script type="module">
  import { auth, db } from "../auth/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  import {
    collection, addDoc, doc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const storage = getStorage();

  const msg = document.getElementById("msg");
  const form = document.getElementById("form");
  const btnPublish = document.getElementById("btnPublish");

  const titre = document.getElementById("titre");
  const ville = document.getElementById("ville");
  const type = document.getElementById("type");
  const prix = document.getElementById("prix");
  const description = document.getElementById("description");
  const files = document.getElementById("files");
  const preview = document.getElementById("preview");

  function show(t){ msg.textContent = t; }
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function pathFor(annonceId, index, file){
    const ext = (file?.name?.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"");
    return `annonces_location/${annonceId}/p${index+1}.${ext || "jpg"}`;
  }

  function renderPreview(fileList){
    preview.innerHTML = "";
    const arr = Array.from(fileList || []).slice(0, 8);
    if (!arr.length) return;

    arr.forEach((f, i) => {
      const div = document.createElement("div");
      div.className = "photo";
      const url = URL.createObjectURL(f);
      div.innerHTML = `
        <img src="${esc(url)}" alt="preview ${i+1}">
        <div class="meta" style="margin-top:8px">#${i+1} ‚Ä¢ ${esc(f.name)}</div>
      `;
      preview.appendChild(div);
    });
  }

  files.addEventListener("change", () => renderPreview(files.files));

  let currentUser = null;

  onAuthStateChanged(auth, (u) => {
    currentUser = u || null;
    if (!currentUser) {
      show("‚ùå Non connect√©. Redirection‚Ä¶");
      setTimeout(() => location.href = "../auth/login.html", 400);
      return;
    }
    show("‚úÖ Connect√©. Tu peux publier une annonce.");
  });

  async function createAnnonceBase(){
    // 1) Cr√©e le doc Firestore (sans photos pour l‚Äôinstant)
    const data = {
      titre: titre.value.trim(),
      ville: ville.value.trim(),
      type: type.value.trim(),
      prix: Number(prix.value || 0),
      description: description.value.trim(),
      ownerUid: currentUser.uid,
      ownerEmail: currentUser.email || "",
      status: "active",
      photos: [],
      photoPaths: [],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    const refDoc = await addDoc(collection(db, "annonces_location"), data);
    return refDoc.id;
  }

  async function uploadPhotosAndAttach(annonceId, fileList){
    const arr = Array.from(fileList || []).slice(0, 8);
    if (!arr.length) return;

    const urls = [];
    const paths = [];

    for (let i = 0; i < arr.length; i++) {
      const f = arr[i];
      const p = pathFor(annonceId, i, f);
      const sref = ref(storage, p);

      await uploadBytes(sref, f, { contentType: f.type || "image/jpeg" });
      const url = await getDownloadURL(sref);

      paths.push(p);
      urls.push(url);
    }

    await updateDoc(doc(db, "annonces_location", annonceId), {
      photos: urls,
      photoPaths: paths,
      updatedAt: serverTimestamp()
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    btnPublish.disabled = true;
    try {
      show("‚è≥ Cr√©ation de l‚Äôannonce‚Ä¶");
      const annonceId = await createAnnonceBase();

      show("‚è≥ Upload des photos‚Ä¶");
      await uploadPhotosAndAttach(annonceId, files.files);

      show("‚úÖ Annonce publi√©e !");
      // Redirige vers la page d‚Äô√©dition (pratique)
      setTimeout(() => {
        location.href = `../annonce_edit.html?id=${encodeURIComponent(annonceId)}`;
      }, 400);
    } catch (err) {
      console.error(err);
      show("‚ùå Erreur (console). V√©rifie les rules Storage et ownerUid.");
    } finally {
      btnPublish.disabled = false;
    }
  });
</script>

</body>
</html>
