<script type="module">
  import { auth, db, storage } from "../shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, getDoc, updateDoc, serverTimestamp } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL, deleteObject } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const msg = document.getElementById("msg");
  const files = document.getElementById("files");
  const btnReplaceAll = document.getElementById("btnReplaceAll");
  const photosEl = document.getElementById("photos");

  const annonceId = new URLSearchParams(location.search).get("id");
  if (!annonceId) {
    msg.textContent = "❌ id manquant.";
    throw new Error("Missing id");
  }

  const annonceRef = doc(db, "annonces_location", annonceId);

  let currentUser = null;
  let annonceData = null;

  function show(t){ msg.textContent = t || ""; }

  function storagePath(annonceId, index, file){
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    return `annonces_location/${annonceId}/p${index+1}.${ext}`;
  }

  async function reloadAnnonce(){
    const snap = await getDoc(annonceRef);
    if (!snap.exists()) {
      show("❌ Annonce introuvable.");
      return;
    }

    annonceData = snap.data();
    const owner = annonceData.ownerUid || annonceData.ownerId;
    const isOwner = currentUser && owner === currentUser.uid;

    if (!isOwner || annonceData.status !== "active") {
      show("❌ Accès refusé.");
      btnReplaceAll.disabled = true;
      return;
    }

    btnReplaceAll.disabled = false;
    show("✅ Modification des photos autorisée.");
  }

  async function replaceAllPhotos(fileList){
    const filesArr = Array.from(fileList).slice(0, 6);

    const oldPaths = annonceData.photoPaths || [];
    for (const p of oldPaths) {
      try { await deleteObject(ref(storage, p)); } catch {}
    }

    const newUrls = [];
    const newPaths = [];

    for (let i = 0; i < filesArr.length; i++) {
      const f = filesArr[i];
      const path = storagePath(annonceId, i, f);
      const sref = ref(storage, path);

      await uploadBytes(sref, f);
      const url = await getDownloadURL(sref);

      newUrls.push(url);
      newPaths.push(path);
    }

    await updateDoc(annonceRef, {
      photos: newUrls,
      photoPaths: newPaths,
      updatedAt: serverTimestamp()
    });

    await reloadAnnonce();
  }

  onAuthStateChanged(auth, async (u) => {
    if (!u) {
      location.href = "../auth/login.html";
      return;
    }
    currentUser = u;
    await reloadAnnonce();
  });

  btnReplaceAll.addEventListener("click", async () => {
    if (!files.files.length) return alert("Choisis des photos.");
    await replaceAllPhotos(files.files);
    alert("✅ Photos mises à jour.");
  });
</script>
