<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî Modifier les photos</title>

  <!-- STYLE GLOBAL -->
  <link rel="stylesheet" href="/wauklink-site/style.css" />
</head>

<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle">Modifier les photos de l‚Äôannonce</div>
    </div>

    <nav class="topbar-nav">
      <a class="btn" href="/wauklink-site/index.html">‚Üê Accueil</a>
    </nav>
  </div>
</header>

<main class="container main-layout">
  <section class="card">
    <h2>Photos de l‚Äôannonce</h2>

    <p id="msg" class="meta" aria-live="polite">
      Chargement‚Ä¶
    </p>

    <p class="muted">
      ‚úî Maximum 6 photos<br>
      ‚úî Remplacement complet des photos existantes
    </p>

    <input
      id="photosInput"
      type="file"
      accept="image/*"
      multiple
    />

    <div class="row mt-xl">
      <button id="btnReplaceAll" class="btn" disabled>
        üíæ Remplacer toutes les photos
      </button>
    </div>
  </section>
</main>

<footer class="footer">
  <div class="container footer-row">
    <span>¬© WAUKLINK</span>

    <nav class="footer-nav">
      <a class="link" href="/wauklink-site/pricing.html">Tarifs</a>
      <a class="link" href="/wauklink-site/legal/index.html">CGU</a>
      <a class="link" href="/wauklink-site/legal/privacy.html">
        Confidentialit√©
      </a>
      <a class="link" href="/wauklink-site/legal/mentions-legales.html">
        Mentions l√©gales
      </a>
    </nav>

    <!-- üîê LIENS ADMIN (CACH√âS PAR D√âFAUT) -->
    <nav class="footer-nav hidden" id="adminLinks">
      <a class="link" href="/wauklink-site/admin/index.html">
        Admin
      </a>
      <span class="sep">¬∑</span>
      <a class="link" href="/wauklink-site/dashboard/moderation-location.html">
        Mod√©ration
      </a>
    </nav>
  </div>
</footer>

<!-- üîê SCRIPT ADMIN -->
<script type="module" src="/wauklink-site/shared/admin_links.js"></script>


<script type="module">
  import { auth, db, storage } from "/wauklink-site/shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { doc, getDoc, updateDoc, serverTimestamp } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL, deleteObject } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const msg = document.getElementById("msg");
  const filesInput = document.getElementById("photosInput");
  const btnReplaceAll = document.getElementById("btnReplaceAll");

  const annonceId = new URLSearchParams(location.search).get("id");
  if (!annonceId) {
    msg.textContent = "‚ùå Identifiant d‚Äôannonce manquant.";
    throw new Error("Missing id");
  }

  const annonceRef = doc(db, "annonces_location", annonceId);
  let currentUser = null;
  let annonceData = null;

  function show(t){ msg.textContent = t || ""; }

  function storagePath(annonceId, index, file){
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    return `annonces_location/${annonceId}/p${index + 1}.${ext}`;
  }

  async function reloadAnnonce(){
    const snap = await getDoc(annonceRef);
    if (!snap.exists()) {
      show("‚ùå Annonce introuvable.");
      return;
    }

    annonceData = snap.data();
    const owner = annonceData.ownerUid || annonceData.ownerId;
    const isOwner = currentUser && owner === currentUser.uid;

    if (!isOwner || annonceData.status !== "active") {
      show("‚ùå Acc√®s refus√©.");
      btnReplaceAll.disabled = true;
      return;
    }

    btnReplaceAll.disabled = false;
    show("‚úÖ Modification des photos autoris√©e.");
  }

  async function replaceAllPhotos(fileList){
    const files = Array.from(fileList).slice(0, 6);

    /* üî• suppression anciennes photos */
    const oldPaths = annonceData.photoPaths || [];
    for (const p of oldPaths) {
      try {
        await deleteObject(ref(storage, p));
      } catch {}
    }

    const newUrls = [];
    const newPaths = [];

    for (let i = 0; i < files.length; i++) {
      const f = files[i];
      const path = storagePath(annonceId, i, f);
      const sref = ref(storage, path);

      await uploadBytes(sref, f);
      const url = await getDownloadURL(sref);

      newUrls.push(url);
      newPaths.push(path);
    }

    await updateDoc(annonceRef, {
      photos: newUrls,
      photoPaths: newPaths,
      updatedAt: serverTimestamp()
    });

    await reloadAnnonce();
  }

  onAuthStateChanged(auth, async (u) => {
    if (!u) {
      location.href = "/wauklink-site/auth/login.html";
      return;
    }
    currentUser = u;
    await reloadAnnonce();
  });

  btnReplaceAll.addEventListener("click", async () => {
    if (!filesInput.files.length) {
      alert("Choisis des photos.");
      return;
    }
    await replaceAllPhotos(filesInput.files);
    alert("‚úÖ Photos mises √† jour.");
  });
</script>

</body>
</html>
