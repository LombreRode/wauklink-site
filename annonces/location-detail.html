import { db, auth } from "./shared/firebase.js";
import { doc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const params = new URLSearchParams(window.location.search);
const id = params.get("id");

const msg = document.getElementById("msg");
const section = document.getElementById("annonce");
const reviewsList = document.getElementById("reviewsList");

// S√©curit√© XSS
const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

if (!id) {
    msg.textContent = "‚ùå Annonce introuvable.";
} else {
    loadAnnonce();
}

async function loadAnnonce() {
    try {
        const snap = await getDoc(doc(db, "annonces", id));
        if (!snap.exists()) {
            msg.textContent = "‚ùå Cette annonce n'existe plus.";
            return;
        }

        const a = snap.data();

        // Remplissage des infos
        document.getElementById("badgeSpec").textContent = a.specialite || a.type;
        document.getElementById("titre").textContent = a.title;
        document.getElementById("meta").textContent = `üìç ${a.city} ‚Ä¢ Publi√© le ${a.createdAt?.toDate().toLocaleDateString() || 'r√©cemment'}`;
        document.getElementById("displayPrice").textContent = a.price > 0 ? `${a.price} ‚Ç¨` : "Sur devis";
        document.getElementById("description").textContent = a.description;

        // Gestion du bouton d'appel
        const callBtn = document.getElementById("callBtn");
        if (a.phone) {
            callBtn.href = `tel:${a.phone}`;
            callBtn.textContent = `üìû Appeler (${a.phone})`;
        } else {
            callBtn.style.display = "none";
        }

        // Photos
        const photosDiv = document.getElementById("photos");
        if (a.images && a.images.length > 0) {
            a.images.forEach(url => {
                const img = document.createElement("img");
                img.src = url;
                photosDiv.appendChild(img);
            });
        }

        // Afficher la section et cacher le chargement
        msg.classList.add("hidden");
        section.classList.remove("hidden");
        
        // Charger les avis
        loadReviews();

        // Activer la section avis si l'utilisateur est connect√©
        onAuthStateChanged(auth, (user) => {
            if (user) document.getElementById("ratingSection").classList.remove("hidden");
        });

    } catch (err) {
        console.error(err);
        msg.textContent = "Erreur de chargement.";
    }
}

// --- GESTION DES AVIS ---
async function loadReviews() {
    reviewsList.innerHTML = "";
    const q = query(collection(db, "reviews"), where("annonceId", "==", id), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    if (snap.empty) {
        reviewsList.innerHTML = "<p class='meta'>Aucun avis pour le moment. Soyez le premier !</p>";
        return;
    }

    snap.forEach(d => {
        const r = d.data();
        const div = document.createElement("div");
        div.className = "review-item"; // Utilise le style de ton CSS
        div.innerHTML = `
            <div class="stars">${"‚≠ê".repeat(r.rating)}</div>
            <p>${esc(r.comment)}</p>
            <small class="meta">Post√© par un utilisateur le ${r.createdAt?.toDate().toLocaleDateString()}</small>
        `;
        reviewsList.appendChild(div);
    });
}

// --- POSTER UN AVIS ---
document.getElementById("rateBtn").onclick = async () => {
    const rating = document.getElementById("ratingValue").value;
    const comment = document.getElementById("ratingComment").value;
    const rateMsg = document.getElementById("rateMsg");

    if (!rating || !comment) {
        alert("Merci de remplir tous les champs.");
        return;
    }

    try {
        await addDoc(collection(db, "reviews"), {
            annonceId: id,
            userId: auth.currentUser.uid,
            rating: parseInt(rating),
            comment: comment,
            createdAt: serverTimestamp()
        });
        rateMsg.textContent = "‚úÖ Avis publi√© !";
        document.getElementById("ratingComment").value = "";
        loadReviews();
    } catch (e) {
        rateMsg.textContent = "‚ùå Erreur lors de la publication.";
    }
};
