<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D√©tail de l'annonce - WAUKLINK</title>
    <link rel="stylesheet" href="../detail.css">
</head>
<body>

    <div id="msg" style="padding: 20px; text-align: center;">Chargement de l'annonce...</div>

    <section id="annonce" class="hidden" style="max-width: 800px; margin: auto; padding: 20px;">
        <span id="badgeSpec" style="background: #004d40; color: white; padding: 5px 10px; border-radius: 5px;"></span>
        <h1 id="titre"></h1>
        <div id="meta" class="meta"></div>
        <div id="displayPrice" style="font-size: 1.5rem; font-weight: bold; margin: 15px 0;"></div>
        
        <div id="photos" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;"></div>
        
        <p id="description" style="white-space: pre-wrap; line-height: 1.6;"></p>
        
        <a id="callBtn" class="btn" style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 5px;"></a>

        <hr style="margin: 30px 0;">

        <h3>Avis des utilisateurs</h3>
        <div id="reviewsList"></div>

        <div id="ratingSection" class="hidden" style="margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <h4>Laisser un avis</h4>
            <select id="ratingValue">
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="3">‚≠ê‚≠ê‚≠ê</option>
                <option value="2">‚≠ê‚≠ê</option>
                <option value="1">‚≠ê</option>
            </select><br><br>
            <textarea id="ratingComment" placeholder="Votre commentaire..." style="width: 100%; height: 80px;"></textarea><br>
            <button id="rateBtn" style="margin-top: 10px; padding: 10px 20px; cursor: pointer;">Publier l'avis</button>
            <p id="rateMsg"></p>
        </div>
    </section>

    <script type="module">
        // Important : on utilise ../ car le fichier est dans le dossier /annonces
        import { db, auth } from "../shared/firebase.js"; 
        import { doc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        const msg = document.getElementById("msg");
        const section = document.getElementById("annonce");
        const reviewsList = document.getElementById("reviewsList");

        const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

        if (!id) {
            msg.textContent = "‚ùå Annonce introuvable.";
        } else {
            loadAnnonce();
        }

        async function loadAnnonce() {
            try {
                const snap = await getDoc(doc(db, "annonces", id));
                if (!snap.exists()) {
                    msg.textContent = "‚ùå Cette annonce n'existe plus.";
                    return;
                }

                const a = snap.data();
                document.getElementById("badgeSpec").textContent = a.specialite || a.type;
                document.getElementById("titre").textContent = a.title;
                document.getElementById("meta").textContent = `üìç ${a.city} ‚Ä¢ Publi√© le ${a.createdAt?.toDate().toLocaleDateString() || 'r√©cemment'}`;
                document.getElementById("displayPrice").textContent = a.price > 0 ? `${a.price} ‚Ç¨` : "Sur devis";
                document.getElementById("description").textContent = a.description;

                const callBtn = document.getElementById("callBtn");
                if (a.phone) {
                    callBtn.href = `tel:${a.phone}`;
                    callBtn.textContent = `üìû Appeler (${a.phone})`;
                } else {
                    callBtn.style.display = "none";
                }

                const photosDiv = document.getElementById("photos");
                if (a.images && a.images.length > 0) {
                    a.images.forEach(url => {
                        const img = document.createElement("img");
                        img.src = url;
                        img.style.width = "200px";
                        img.style.borderRadius = "8px";
                        photosDiv.appendChild(img);
                    });
                }

                msg.classList.add("hidden");
                section.classList.remove("hidden");
                
                loadReviews();

                onAuthStateChanged(auth, (user) => {
                    if (user) document.getElementById("ratingSection").classList.remove("hidden");
                });

            } catch (err) {
                console.error(err);
                msg.textContent = "Erreur de chargement.";
            }
        }

        async function loadReviews() {
            reviewsList.innerHTML = "";
            try {
                const q = query(collection(db, "reviews"), where("annonceId", "==", id), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                if (snap.empty) {
                    reviewsList.innerHTML = "<p>Aucun avis pour le moment.</p>";
                    return;
                }
                snap.forEach(d => {
                    const r = d.data();
                    const div = document.createElement("div");
                    div.style.borderBottom = "1px solid #eee";
                    div.style.padding = "10px 0";
                    div.innerHTML = `
                        <div style="color: #f39c12;">${"‚≠ê".repeat(r.rating)}</div>
                        <p>${esc(r.comment)}</p>
                        <small style="color: #777;">Le ${r.createdAt?.toDate().toLocaleDateString()}</small>
                    `;
                    reviewsList.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById("rateBtn").onclick = async () => {
            const rating = document.getElementById("ratingValue").value;
            const comment = document.getElementById("ratingComment").value;
            if (!comment) return alert("Merci d'√©crire un commentaire.");

            try {
                await addDoc(collection(db, "reviews"), {
                    annonceId: id,
                    userId: auth.currentUser.uid,
                    rating: parseInt(rating),
                    comment: comment,
                    createdAt: serverTimestamp()
                });
                document.getElementById("ratingComment").value = "";
                loadReviews();
            } catch (e) { alert("Erreur d'envoi"); }
        };
    </script>
</body>
</html>
