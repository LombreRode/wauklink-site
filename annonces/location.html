<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WAUKLINK ‚Äî Annonces Location</title>
  <link rel="stylesheet" href="../style.css?v=1" />
  <style>
    .page { padding: 24px 0; }
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .meta{opacity:.85;font-size:13px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;opacity:.9}
    .search{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.2);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:14px}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px;cursor:pointer}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .price{font-weight:900}
    .stars{font-size:13px;opacity:.9;margin-top:6px}
    .pager{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:16px}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .btn-danger{
      padding:10px 12px;border-radius:12px;cursor:pointer;
      border:1px solid rgba(255,80,80,.45);
      background: rgba(255,80,80,.12);
      color:#fff;
    }
    .btn-danger:hover{ filter:brightness(1.12); }

    dialog{border:none;border-radius:18px;padding:0;max-width:760px;width:min(92vw,760px);background:#0b1220;color:#fff}
    .modalTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;border-bottom:1px solid rgba(255,255,255,.14);padding:16px}
    .modalBody{padding:16px}
    .modalActions{display:flex;gap:10px;flex-wrap:wrap;padding:16px;border-top:1px solid rgba(255,255,255,.14)}
    .closeX{background:transparent;border:1px solid rgba(255,255,255,.14);border-radius:12px;color:#fff;padding:6px 10px;cursor:pointer}

    .photos{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
    .ph{border:1px solid rgba(255,255,255,.14);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.04);aspect-ratio:4/3}
    .ph img{width:100%;height:100%;object-fit:cover;display:block}

    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kvc{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px;background:rgba(255,255,255,.04)}
    .k{opacity:.75;font-size:12px}
    .v{font-weight:900}

    /* ‚≠ê rating UI */
    .ratingBox{margin-top:16px;border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px;background:rgba(255,255,255,.04)}
    .ratingStars{font-size:22px;display:flex;gap:6px;margin-top:6px;user-select:none}
    .ratingStars span{cursor:pointer;line-height:1}
    .ratingStars span:hover{filter:brightness(1.2)}
  </style>
</head>

<body>
<header class="topbar">
  <div class="container topbar-row">
    <div>
      <h1>WAUKLINK</h1>
      <div class="subtitle" id="subTitle">Annonces ‚Ä¢ Location</div>
    </div>
    <nav style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <a href="../index.html" style="text-decoration:underline;opacity:.9;">‚Üê Accueil</a>
      <a href="../pricing.html" style="text-decoration:underline;opacity:.9;">Tarifs</a>
      <a href="../legal/index.html" style="text-decoration:underline;opacity:.9;">CGU</a>
    </nav>
  </div>
</header>

<main class="container page">
  <div class="top">
    <h2 style="margin:0" id="pageTitle">Offres Location</h2>
    <span class="badge" id="pageBadge">20 annonces / page</span>
  </div>

  <p class="meta" id="pageMeta">
    Clique sur une annonce pour voir le d√©tail. Si c‚Äôest ton annonce, tu peux la modifier / supprimer.
  </p>

  <input id="q" class="search" placeholder="Rechercher : ville, type (studio, T2‚Ä¶), prix‚Ä¶" />
  <div id="list" class="grid"></div>

  <div class="pager">
    <button id="prev" class="btn" disabled>‚óÄ Pr√©c√©dent</button>
    <span id="pageInfo" class="meta">Page 1</span>
    <button id="next" class="btn" disabled>Suivant ‚ñ∂</button>
  </div>
</main>

<footer class="footer">
  ¬© WAUKLINK ‚Äî
  <a href="../legal/privacy.html">Confidentialit√©</a> |
  <a href="../legal/mentions-legales.html">Mentions l√©gales</a>
</footer>

<dialog id="detailDlg">
  <div class="modalTop">
    <div>
      <div id="dTitle" style="font-weight:900;font-size:18px"></div>
      <div id="dMeta" class="meta"></div>
      <div id="dStars" class="stars"></div>
    </div>
    <button class="closeX" id="closeDlg">‚úï</button>
  </div>

  <div class="modalBody">
    <div class="kv">
      <div class="kvc"><div class="k">Prix</div><div class="v" id="dPrice"></div></div>
      <div class="kvc"><div class="k">Type</div><div class="v" id="dType"></div></div>
      <div class="kvc"><div class="k">Ville</div><div class="v" id="dVille"></div></div>
      <div class="kvc"><div class="k">Surface</div><div class="v" id="dSurface"></div></div>
    </div>

    <div style="margin-top:12px">
      <div class="k">Description</div>
      <div id="dDesc" style="margin-top:6px;white-space:pre-wrap"></div>
    </div>

    <!-- ‚≠ê NOTE -->
    <div class="ratingBox">
      <div class="k">Votre note</div>
      <div id="ratingStars" class="ratingStars" aria-label="Noter cette annonce">
        <span data-v="1">‚òÜ</span>
        <span data-v="2">‚òÜ</span>
        <span data-v="3">‚òÜ</span>
        <span data-v="4">‚òÜ</span>
        <span data-v="5">‚òÜ</span>
      </div>
      <div id="ratingMsg" class="meta" style="margin-top:6px"></div>
    </div>

    <div style="margin-top:14px">
      <div class="k">Photos (max 6)</div>
      <div id="dPhotos" class="photos"></div>
    </div>
  </div>

  <div class="modalActions">
    <a id="btnMail" class="btn" href="#" style="text-decoration:none">‚úâ Joindre par mail</a>
    <a id="btnTel" class="btn" href="#" style="text-decoration:none;display:none">üìû Appeler</a>
    <button id="btnReport" class="btn-danger">üö© Signaler</button>
    <button id="btnEdit" class="btn" style="display:none">‚úèÔ∏è Modifier</button>
    <button id="btnDelete" class="btn" style="display:none">üóëÔ∏è Supprimer</button>
    <button id="backBtn" class="btn">‚Ü© Retour aux annonces</button>
  </div>
</dialog>

<script type="module">
  // ====== CONFIG ======
  const PER_PAGE = 20;

  // ====== PARAMS (duree) ======
  const params = new URLSearchParams(window.location.search);
  const dureeParam = (params.get("duree") || "").trim().toLowerCase(); // "saisonniere" | "annuelle" | ""
  const allowedDuree = (dureeParam === "saisonniere" || dureeParam === "annuelle") ? dureeParam : "";
  const dureeLabel = allowedDuree === "saisonniere"
    ? "Location saisonni√®re"
    : allowedDuree === "annuelle"
      ? "Location annuelle"
      : "Location (toutes)";

  // ====== UI TITLES ======
  const subTitle = document.getElementById("subTitle");
  const pageTitle = document.getElementById("pageTitle");
  const pageMeta = document.getElementById("pageMeta");
  const pageBadge = document.getElementById("pageBadge");
  document.title = `WAUKLINK ‚Äî ${dureeLabel}`;
  subTitle.textContent = `Annonces ‚Ä¢ ${dureeLabel}`;
  pageTitle.textContent = (allowedDuree ? `Offres ‚Ä¢ ${dureeLabel}` : "Offres Location (toutes dur√©es)");
  pageBadge.textContent = `${PER_PAGE} annonces / page`;
  pageMeta.textContent =
    allowedDuree
      ? `Tu es dans : ${dureeLabel}. Clique sur une annonce pour voir le d√©tail.`
      : `Clique sur une annonce pour voir le d√©tail. Si c‚Äôest ton annonce, tu peux la modifier / supprimer.`;

  // ====== IMPORTS ======
  import { db, auth } from "../auth/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, query, where, orderBy, limit, startAfter, getDocs,
    doc, updateDoc, deleteDoc, addDoc, serverTimestamp,
    getDoc, setDoc, runTransaction, increment
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ====== UI ======
  const list = document.getElementById("list");
  const qInput = document.getElementById("q");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  const pageInfo = document.getElementById("pageInfo");

  const dlg = document.getElementById("detailDlg");
  const closeDlg = document.getElementById("closeDlg");
  const backBtn = document.getElementById("backBtn");

  const dTitle = document.getElementById("dTitle");
  const dMeta = document.getElementById("dMeta");
  const dStars = document.getElementById("dStars");
  const dPrice = document.getElementById("dPrice");
  const dType = document.getElementById("dType");
  const dVille = document.getElementById("dVille");
  const dSurface = document.getElementById("dSurface");
  const dDesc = document.getElementById("dDesc");
  const dPhotos = document.getElementById("dPhotos");

  const btnMail = document.getElementById("btnMail");
  const btnTel = document.getElementById("btnTel");
  const btnEdit = document.getElementById("btnEdit");
  const btnDelete = document.getElementById("btnDelete");
  const btnReport = document.getElementById("btnReport");

  // ‚≠ê rating UI
  const ratingStars = document.getElementById("ratingStars");
  const ratingMsg = document.getElementById("ratingMsg");

  // ====== STATE ======
  let page = 1;
  let lastDoc = null;
  let cursorStack = [];
  let currentItems = [];
  let currentUser = null;
  let currentDetail = null;

  onAuthStateChanged(auth, (u) => { currentUser = u || null; });

  // ====== HELPERS ======
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function stars(avg=0, count=0){
    const a = Math.max(0, Math.min(5, Number(avg||0)));
    const full = Math.round(a);
    const s = "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(5-full, 10-full);
    return `${s}  ${a.toFixed(1)}/5 (${count} avis)`;
  }

  function renderStars(val = 0){
    [...ratingStars.children].forEach(s => {
      s.textContent = Number(s.dataset.v) <= val ? "‚òÖ" : "‚òÜ";
    });
  }

  function renderList(items){
    list.innerHTML = "";
    if(!items.length){
      list.innerHTML = `<div class="meta">Aucune annonce pour l‚Äôinstant.</div>`;
      return;
    }
    items.forEach((a, idx) => {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900">${esc(a.titre)}</div>
            <div class="meta">${esc(a.ville)} ‚Ä¢ ${esc(a.type)} ‚Ä¢ ${esc(a.surface || "")}</div>
            <div class="stars">${esc(stars(a.ratingAvg || 0, a.ratingCount || 0))}</div>
          </div>
          <div class="price">${esc(a.prix)}‚Ç¨</div>
        </div>
        <div class="meta" style="margin-top:10px;opacity:.8">Cliquer pour ouvrir ‚Üí</div>
      `;
      el.addEventListener("click", () => openDetail(idx));
      list.appendChild(el);
    });
  }

  function closeDetail(){ if(dlg.open) dlg.close(); }
  closeDlg.addEventListener("click", closeDetail);
  backBtn.addEventListener("click", closeDetail);

  async function sendReport(annonce){
    const reason = prompt("Pourquoi signalez-vous cette annonce ? (min 5 caract√®res)");
    if (!reason || reason.trim().length < 5) {
      alert("Motif trop court (min 5 caract√®res).");
      return;
    }
    try {
      await addDoc(collection(db, "reports"), {
        annonceId: annonce.id,
        annonceOwnerUid: annonce.ownerUid || null,
        annonceTitre: annonce.titre || null,
        annonceVille: annonce.ville || null,
        annonceType: annonce.type || null,
        annoncePrix: annonce.prix ?? null,
        reason: reason.trim(),
        reporterUid: currentUser ? currentUser.uid : null,
        reporterEmail: currentUser ? currentUser.email : null,
        status: "open",
        createdAt: serverTimestamp()
      });
      alert("‚úÖ Signalement envoy√©. Merci !");
    } catch (e) {
      console.error(e);
      alert("‚ùå Impossible d‚Äôenvoyer le signalement (rules/connexion).");
    }
  }

  async function openDetail(index){
    const a = currentItems[index];
    if(!a) return;
    currentDetail = a;

    dTitle.textContent = a.titre || "Annonce";
    const dureeTxt = a.duree ? ` ‚Ä¢ ${a.duree}` : "";
    dMeta.textContent = `${a.ville || ""} ‚Ä¢ ${a.type || ""}${dureeTxt}`;
    dStars.textContent = stars(a.ratingAvg || 0, a.ratingCount || 0);

    dPrice.textContent = (a.prix ?? "") + "‚Ç¨";
    dType.textContent = a.type ?? "";
    dVille.textContent = a.ville ?? "";
    dSurface.textContent = a.surface ?? "-";
    dDesc.textContent = a.description ?? "‚Äî";

    // Photos
    dPhotos.innerHTML = "";
    const photos = Array.isArray(a.photos) ? a.photos.filter(Boolean).slice(0, 6) : [];
    if(photos.length === 0){
      dPhotos.innerHTML = `<div class="meta">Aucune photo.</div>`;
    } else {
      photos.forEach((url) => {
        const ph = document.createElement("div");
        ph.className = "ph";
        ph.innerHTML = `<img src="${esc(url)}" alt="Photo annonce">`;
        dPhotos.appendChild(ph);
      });
    }

    // Contact
    const mail = (a.contactEmail || "").trim();
    const tel = (a.contactPhone || "").trim();
    const subject = encodeURIComponent("WAUKLINK ‚Äî Contact annonce : " + (a.titre || ""));
    const body = encodeURIComponent(
      `Bonjour,\n\nJe vous contacte au sujet de votre annonce : ${a.titre || ""}\nVille : ${a.ville || ""}\n\nMon message :\n`
    );
    btnMail.href = mail ? `mailto:${mail}?subject=${subject}&body=${body}` : "#";
    btnMail.style.opacity = mail ? "1" : ".5";
    btnMail.onclick = (e) => { if(!mail){ e.preventDefault(); alert("Email non disponible sur cette annonce."); } };

    if(tel){
      btnTel.href = `tel:${tel}`;
      btnTel.style.display = "inline-block";
    } else {
      btnTel.style.display = "none";
    }

    // Signaler
    btnReport.onclick = async () => {
      if (!currentDetail) return;
      await sendReport(currentDetail);
    };

    // Proprio
    const isOwner = !!currentUser && !!a.ownerUid && currentUser.uid === a.ownerUid;
    btnEdit.style.display = isOwner ? "inline-block" : "none";
    btnDelete.style.display = isOwner ? "inline-block" : "none";

    btnDelete.onclick = async () => {
      if (!confirm("Supprimer cette annonce ?")) return;
      try {
        await deleteDoc(doc(db, "annonces_location", a.id));
        alert("‚úÖ Annonce supprim√©e !");
        closeDetail();
        await loadPage("stay");
      } catch (e) {
        console.error(e);
        alert("‚ùå Impossible de supprimer (permissions / rules).");
      }
    };

    btnEdit.onclick = async () => {
      const newTitre = prompt("Titre :", a.titre ?? "");
      if (newTitre === null) return;
      const newVille = prompt("Ville :", a.ville ?? "");
      if (newVille === null) return;
      const newType = prompt("Type (Studio, T1, T2...) :", a.type ?? "");
      if (newType === null) return;
      const newSurface = prompt("Surface (ex: 25 m¬≤) :", a.surface ?? "");
      if (newSurface === null) return;
      const newPrix = prompt("Prix (‚Ç¨ / mois) :", a.prix ?? "");
      if (newPrix === null) return;
      const newDesc = prompt("Description :", a.description ?? "");
      if (newDesc === null) return;

      const prixNum = Number(newPrix);
      if (!Number.isFinite(prixNum) || prixNum <= 0) {
        alert("‚ùå Prix invalide.");
        return;
      }

      try {
        await updateDoc(doc(db, "annonces_location", a.id), {
          titre: String(newTitre).trim(),
          ville: String(newVille).trim(),
          type: String(newType).trim(),
          surface: String(newSurface).trim(),
          prix: prixNum,
          description: String(newDesc).trim()
        });
        alert("‚úÖ Annonce modifi√©e !");
        closeDetail();
        await loadPage("stay");
      } catch (e) {
        console.error(e);
        alert("‚ùå Impossible de modifier (permissions / rules).");
      }
    };

    // ‚≠ê Charger la note utilisateur (si connect√©)
    ratingMsg.textContent = "";
    renderStars(0);
    if (!currentUser) {
      ratingMsg.textContent = "Connecte-toi pour noter.";
    } else {
      try{
        const rRef = doc(db, "annonces_location", a.id, "ratings", currentUser.uid);
        const snap = await getDoc(rRef);
        if (snap.exists()) {
          renderStars(snap.data()?.value || 0);
          ratingMsg.textContent = "Vous avez d√©j√† not√© cette annonce.";
        } else {
          ratingMsg.textContent = "Clique sur une √©toile pour noter.";
        }
      } catch(e){
        console.error(e);
        ratingMsg.textContent = "Impossible de charger votre note.";
      }
    }

    dlg.showModal();
  }

  // ‚≠ê Click √©toiles (1 note par user)
  ratingStars.addEventListener("click", async (e) => {
    const v = Number(e.target?.dataset?.v);
    if (!v || v < 1 || v > 5) return;

    if (!currentUser) {
      alert("üîí Connecte-toi pour noter.");
      return;
    }
    if (!currentDetail) return;

    const annonceRef = doc(db, "annonces_location", currentDetail.id);
    const rateRef = doc(db, "annonces_location", currentDetail.id, "ratings", currentUser.uid);

    try {
      await runTransaction(db, async (tx) => {
        const existing = await tx.get(rateRef);
        if (existing.exists()) throw new Error("ALREADY_RATED");

        const annonceSnap = await tx.get(annonceRef);
        if (!annonceSnap.exists()) throw new Error("MISSING_ANNONCE");

        const data = annonceSnap.data() || {};
        const count = Number(data.ratingCount || 0);
        const avg = Number(data.ratingAvg || 0);

        const newCount = count + 1;
        const newAvg = ((avg * count) + v) / newCount;

        tx.set(rateRef, { value: v, createdAt: serverTimestamp() });
        tx.update(annonceRef, {
          ratingCount: increment(1),
          ratingAvg: Number(newAvg.toFixed(2))
        });
      });

      renderStars(v);
      ratingMsg.textContent = "Merci pour votre note ‚≠ê";

      // (optionnel) met √† jour l‚ÄôUI locale
      currentDetail.ratingCount = (currentDetail.ratingCount || 0) + 1;
      currentDetail.ratingAvg = Number((((currentDetail.ratingAvg || 0) * (currentDetail.ratingCount - 1)) + v) / (currentDetail.ratingCount)).toFixed(2);
      dStars.textContent = stars(currentDetail.ratingAvg || 0, currentDetail.ratingCount || 0);

    } catch (err) {
      if (String(err?.message).includes("ALREADY_RATED")) {
        alert("Tu as d√©j√† not√© cette annonce.");
        return;
      }
      console.error(err);
      alert("‚ùå Erreur lors de la notation.");
    }
  });

  // ====== QUERY BUILDER (avec filtre duree) ======
  function makeBaseQuery(){
    const baseRef = collection(db, "annonces_location");
    const constraints = [ where("status", "==", "active") ];
    if (allowedDuree) constraints.push(where("duree", "==", allowedDuree));
    constraints.push(orderBy("createdAt", "desc"));
    constraints.push(limit(PER_PAGE));
    return query(baseRef, ...constraints);
  }
  function makeNextQuery(){
    const baseRef = collection(db, "annonces_location");
    const constraints = [ where("status", "==", "active") ];
    if (allowedDuree) constraints.push(where("duree", "==", allowedDuree));
    constraints.push(orderBy("createdAt", "desc"));
    constraints.push(startAfter(lastDoc));
    constraints.push(limit(PER_PAGE));
    return query(baseRef, ...constraints);
  }
  function makePrevQuery(){
    const baseRef = collection(db, "annonces_location");
    const constraints = [ where("status", "==", "active") ];
    if (allowedDuree) constraints.push(where("duree", "==", allowedDuree));
    constraints.push(orderBy("createdAt", "desc"));
    cursorStack.pop();
    const prevCursor = cursorStack[cursorStack.length - 1] || null;
    if (prevCursor) constraints.push(startAfter(prevCursor));
    constraints.push(limit(PER_PAGE));
    return query(baseRef, ...constraints);
  }

  // ====== LOAD PAGE (pagination) ======
  async function loadPage(direction = "stay"){
    let qy = makeBaseQuery();
    if(direction === "next" && lastDoc) qy = makeNextQuery();
    if(direction === "prev") qy = makePrevQuery();

    const snap = await getDocs(qy);
    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    lastDoc = snap.docs.length ? snap.docs[snap.docs.length - 1] : null;

    if(direction === "next"){
      if(snap.docs.length) cursorStack.push(snap.docs[0]);
      page++;
    } else if(direction === "prev"){
      page = Math.max(1, page - 1);
    } else {
      page = 1;
      cursorStack = [];
      if(snap.docs.length) cursorStack.push(snap.docs[0]);
    }

    const s = (qInput.value || "").toLowerCase().trim();
    currentItems = s
      ? items.filter(a => ((a.titre||"")+" "+(a.ville||"")+" "+(a.type||"")+" "+(a.prix||"")).toLowerCase().includes(s))
      : items;

    renderList(currentItems);
    pageInfo.textContent = `Page ${page}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = items.length < PER_PAGE;
  }

  // ====== EVENTS ======
  qInput.addEventListener("input", () => loadPage("stay"));
  nextBtn.addEventListener("click", () => loadPage("next"));
  prevBtn.addEventListener("click", () => loadPage("prev"));

  // ====== BOOT ======
  await loadPage("stay");
</script>

<script type="module" src="../auth/status.js"></script>
<script type="module" src="../auth/user_sync.js"></script>
</body>
</html>
