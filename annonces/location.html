<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WAUKLINK â€” Annonces</title>
<link rel="stylesheet" href="../style.css">
<style>
.page{padding:24px 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:16px;padding:14px;cursor:pointer}
.btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
.btn-danger{border:1px solid rgba(255,80,80,.45);background:rgba(255,80,80,.12)}
dialog{border:none;border-radius:18px;width:min(92vw,760px);background:#0b1220;color:#fff}
.photos{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.ph{position:relative}
.ph img{width:100%;border-radius:12px}
.del{position:absolute;top:6px;right:6px}
.hidden{display:none}
</style>
</head>

<body>
<main class="page container">
<h2>Annonces location</h2>
<div id="list" class="grid"></div>
</main>

<dialog id="dlg">
<div style="padding:16px">
<h3 id="dTitle"></h3>
<p id="dDesc"></p>

<h4>Photos</h4>
<div id="dPhotos" class="photos"></div>

<div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
<button id="btnPhotos" class="btn hidden">ðŸ“¸ Modifier photos</button>
<button id="close" class="btn">Fermer</button>
</div>
</div>
</dialog>

<script type="module">
import { db, auth, storage } from "../auth/firebase.js";
import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const list = document.getElementById("list");
const dlg = document.getElementById("dlg");
const dTitle = document.getElementById("dTitle");
const dDesc = document.getElementById("dDesc");
const dPhotos = document.getElementById("dPhotos");
const btnPhotos = document.getElementById("btnPhotos");
const closeBtn = document.getElementById("close");

let currentUser = null;
let currentAnnonce = null;

onAuthStateChanged(auth, u => currentUser = u);

function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}

async function load(){
const snap = await getDocs(collection(db,"annonces_location"));
list.innerHTML="";
snap.forEach(d=>{
const a = {id:d.id,...d.data()};
if(a.status!=="active") return;
const el=document.createElement("div");
el.className="card";
el.innerHTML=`<strong>${esc(a.titre)}</strong><br>${esc(a.ville)} â€¢ ${esc(a.prix)}â‚¬`;
el.onclick=()=>openAnnonce(a);
list.appendChild(el);
});
}

async function openAnnonce(a){
currentAnnonce=a;
dTitle.textContent=a.titre;
dDesc.textContent=a.description||"â€”";
dPhotos.innerHTML="";

(a.photos||[]).forEach((url,i)=>{
const div=document.createElement("div");
div.className="ph";
div.innerHTML=`<img src="${url}">`;
if(currentUser && a.ownerUid===currentUser.uid){
const b=document.createElement("button");
b.textContent="ðŸ—‘ï¸";
b.className="btn btn-danger del";
b.onclick=()=>deletePhoto(i);
div.appendChild(b);
}
dPhotos.appendChild(div);
});

const canEditPhotos =
currentUser &&
a.ownerUid===currentUser.uid &&
a.status==="active";

btnPhotos.classList.toggle("hidden",!canEditPhotos);
btnPhotos.onclick=()=>alert("ðŸ‘‰ Utilise annonce_edit.html pour remplacer les photos");

dlg.showModal();
}

async function deletePhoto(index){
if(!confirm("Supprimer cette photo ?")) return;
const paths=[...(currentAnnonce.photoPaths||[])];
const urls=[...(currentAnnonce.photos||[])];
await deleteObject(ref(storage,paths[index]));
paths.splice(index,1);
urls.splice(index,1);
await updateDoc(doc(db,"annonces_location",currentAnnonce.id),{
photos:urls,
photoPaths:paths,
updatedAt:new Date()
});
dlg.close();
await load();
}

closeBtn.onclick=()=>dlg.close();
load();
</script>
</body>
</html>
