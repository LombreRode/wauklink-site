<script type="module">
  import { auth, db } from "../shared/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, query, where, getDocs, addDoc, serverTimestamp
  } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const typeEl = document.getElementById("type");
  const proAction = document.getElementById("proAction");

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) return;

    const data = snap.data();

    // ğŸ‘‘ ADMIN
    if (data.role === "admin") {
      typeEl.innerHTML =
        `<strong>Type de compte :</strong> ğŸ‘‘ Administrateur`;
      return;
    }

    // ğŸŸ¢ PRO
    if (data.isPro === true) {
      typeEl.innerHTML =
        `<strong>Type de compte :</strong> ğŸŸ¢ Compte PRO`;
      return;
    }

    // âšª USER STANDARD
    typeEl.innerHTML =
      `<strong>Type de compte :</strong> âšª Compte standard`;

    // â³ Demande PRO en attente ?
    const q = query(
      collection(db, "pro_requests"),
      where("userId", "==", user.uid),
      where("status", "==", "pending")
    );
    const reqSnap = await getDocs(q);

    if (!reqSnap.empty) {
      proAction.textContent = "â³ Demande PRO en attente de validation";
      return;
    }

    // ğŸ”˜ Bouton Passer PRO
    const btn = document.createElement("button");
    btn.className = "btn btn-ok";
    btn.textContent = "ğŸš€ Passer PRO";

    btn.onclick = async () => {
      btn.disabled = true;
      await addDoc(collection(db, "pro_requests"), {
        userId: user.uid,
        status: "pending",
        createdAt: serverTimestamp()
      });
      proAction.textContent = "â³ Demande PRO envoyÃ©e";
    };

    proAction.appendChild(btn);
  });
</script>

